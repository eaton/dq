"use strict";var P=Object.defineProperty;var c=(t,n)=>P(t,"name",{value:n,configurable:!0});var k=require("jszip"),g=require("fs-jetpack"),d=require("xml2js"),r=require("zod"),j=require("micromatch"),B=require("utimes"),C=require("gray-matter"),h=require("jimp"),O=require("turndown");async function f(t){if(typeof t=="string"){const n=await g.readAsync(t,"buffer").then(e=>{if(e)return k.loadAsync(e)});if(n===void 0)throw new Error("EBook file could not be read");return n}else return t}c(f,"loadBook");async function S(t){return await f(t).then(n=>Object.keys(n.files))}c(S,"listContents");const M=d.Parser;async function w(t){const n=await y(t),i=await new M({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[a=>a.startsWith("dc:")?a.replace("dc:",""):a]}).parseStringPromise(n);return A.parse(i).package.metadata}c(w,"getMeta");async function y(t){return await f(t).then(n=>n.files["OEBPS/content.opf"]?.async("string"))}c(y,"getRawMeta");const m=r.z.string().or(r.z.object({text:r.z.string()}).transform(t=>t.text)),$=r.z.object({title:r.z.string(),creator:r.z.array(m).or(m).optional(),contributor:r.z.array(m).optional().optional(),publisher:r.z.string().optional(),rights:r.z.string().optional(),subject:r.z.array(r.z.string()).optional(),language:r.z.string(),identifier:m,source:r.z.string().optional(),date:r.z.string()}),A=r.z.object({package:r.z.object({metadata:$})}),E=d.Parser;async function z(t){const n=await b(t),i=await new E({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(n);return L.parse(i).ncx.navMap.navPoint}c(z,"getToc");async function b(t){return await f(t).then(n=>n.files["OEBPS/toc.ncx"]?.async("string"))}c(b,"getRawToc");const q=r.z.string().or(r.z.object({text:r.z.string()}).transform(t=>t.text)),R=r.z.string().or(r.z.object({src:r.z.string()}).transform(t=>t.src)),T=r.z.object({id:r.z.string(),playOrder:r.z.coerce.number(),navLabel:q,content:R}),L=r.z.object({ncx:r.z.object({navMap:r.z.object({navPoint:r.z.array(T)})})});async function v(t,n){const e=await f(t);if(e.files[`OEBPS/${n}`]!==void 0)return await e.files[`OEBPS/${n}`].async("string")}c(v,"getChapter");const D={output:"./output",preserveDates:!0};async function x(t,n={}){const e={...D,...n},i=await f(t);let a=Object.keys(i.files);e.matching!==void 0&&(a=a.filter(s=>j.isMatch(s,e.matching)));const o=g.dir(e.output??".");for(const s of a){const l=i.file(s);if(l){const u=e.rewritePaths?e.rewritePaths(s):s,p=await l.async("nodebuffer");o.write(u,p),e.preserveDates&&await B.utimes(o.path(u),{btime:l.date,mtime:l.date})}}}c(x,"copyFiles");async function N(t){const n=await f(t);if(n.files["OEBPS/image/cover.jpg"]!==void 0)return await n.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(e=>h.read(e)).then(e=>e.getPixelColor(50,500)).then(e=>h.intToRGBA(e))}c(N,"getCoverColor");const F={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function J(t,n={}){return G(n).turndown(t)}c(J,"toMarkdown");function G(t={}){const n={...F,blankReplacement:(i,a)=>a.isBlock&&!a.matches("figure")?`

`:a.outerHTML,...t},e=new O(n);return e.remove("title"),e.addRule("listItem",{filter:"li",replacement:(i,a,o)=>{i=i.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let s=o.bulletListMarker+" ";const l=a.parentNode;if(l.nodeName==="OL"){const u=l.getAttribute("start"),p=Array.prototype.indexOf.call(l.children,a);s=(u?Number(u)+p:p+1)+". "}return s+i+(a.nextSibling&&!/\n$/.test(i)?`
`:"")}}),e.addRule("aba-figure",{filter:"figure",replacement:function(i,a){const o=a.firstChild.firstChild.firstChild,s=o.getAttribute("src"),l=o.getAttribute("alt"),u=a.firstChild.children[1].textContent;return`![${l}](${s} "${u}")`}}),e}c(G,"toMarkdownParser");const H={data:"./output",images:"./output/images",chapters:"./output/src",fonts:!1,unshortenLinks:!0};async function I(t,n={}){const e={...H,...n},i=await f(t);if(e.data){const a=await w(i),o=await N(i);g.dir(e.data).write("meta.json",{color:o,...a})}if(e.chapters){const a=await z(i);for(const o of a){if(o.content.indexOf("#")>-1)continue;const s=await v(i,o.content);if(s){const l={title:o.navLabel,order:o.playOrder},u=J(s),p=o.content.replace(".xhtml",".md");g.dir(e.chapters).write(p,C.stringify({content:u},l))}}}e.images&&await x(i,{matching:"**/image/*.*",preserveDates:!0,rewritePaths:a=>a.replace("OEBPS/image/",""),output:e.images})}c(I,"processBook"),exports.copyFiles=x,exports.getChapter=v,exports.getMeta=w,exports.getRawMeta=y,exports.getRawToc=b,exports.getToc=z,exports.listContents=S,exports.loadBook=f,exports.processBook=I;
