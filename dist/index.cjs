"use strict";var j=Object.defineProperty;var u=(e,r)=>j(e,"name",{value:r,configurable:!0});var P=require("jszip"),d=require("fs-jetpack"),m=require("xml2js"),s=require("zod"),O=require("micromatch"),q=require("utimes"),T=require("gray-matter"),h=require("jimp"),S=require("turndown"),B=require("wretch"),C=require("p-settle"),M=require("cheerio");function $(e){var r=Object.create(null);return e&&Object.keys(e).forEach(function(t){if(t!=="default"){var a=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,a.get?a:{enumerable:!0,get:function(){return e[t]}})}}),r.default=e,Object.freeze(r)}u($,"_interopNamespaceDefault");var A=$(M);async function f(e){if(typeof e=="string"){const r=await d.readAsync(e,"buffer").then(t=>{if(t)return P.loadAsync(t)});if(r===void 0)throw new Error("EBook file could not be read");return r}else return e}u(f,"loadBook");async function E(e){return await f(e).then(r=>Object.keys(r.files))}u(E,"listContents");const L=m.Parser;async function w(e){const r=await x(e),a=await new L({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[n=>n.startsWith("dc:")?n.replace("dc:",""):n]}).parseStringPromise(r);return D.parse(a).package.metadata}u(w,"getMeta");async function x(e){return await f(e).then(r=>r.files["OEBPS/content.opf"]?.async("string"))}u(x,"getRawMeta");const g=s.z.string().or(s.z.object({text:s.z.string()}).transform(e=>e.text)),R=s.z.object({title:s.z.string(),creator:s.z.array(g).or(g).optional(),contributor:s.z.array(g).optional().optional(),publisher:s.z.string().optional(),rights:s.z.string().optional(),subject:s.z.array(s.z.string()).optional(),language:s.z.string(),identifier:g,source:s.z.string().optional(),date:s.z.string()}),D=s.z.object({package:s.z.object({metadata:R})}),F=m.Parser;async function y(e){const r=await b(e),a=await new F({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(r);return G.parse(a).ncx.navMap.navPoint}u(y,"getToc");async function b(e){return await f(e).then(r=>r.files["OEBPS/toc.ncx"]?.async("string"))}u(b,"getRawToc");const N=s.z.string().or(s.z.object({text:s.z.string()}).transform(e=>e.text)),_=s.z.string().or(s.z.object({src:s.z.string()}).transform(e=>e.src)),J=s.z.object({id:s.z.string(),playOrder:s.z.coerce.number(),navLabel:N,content:_}),G=s.z.object({ncx:s.z.object({navMap:s.z.object({navPoint:s.z.array(J)})})});async function z(e,r){const t=await f(e);if(t.files[`OEBPS/${r}`]!==void 0)return await t.files[`OEBPS/${r}`].async("string")}u(z,"getChapter");const H={output:"./output",preserveDates:!0};async function v(e,r={}){const t={...H,...r},a=await f(e);let n=Object.keys(a.files);t.matching!==void 0&&(n=n.filter(i=>O.isMatch(i,t.matching)));const o=d.dir(t.output??".");for(const i of n){const c=a.file(i);if(c){const l=t.rewritePaths?t.rewritePaths(i):i,p=await c.async("nodebuffer");o.write(l,p),t.preserveDates&&await q.utimes(o.path(l),{btime:c.date,mtime:c.date})}}}u(v,"copyFiles");async function I(e,r="rgba"){const t=await f(e);if(t.files["OEBPS/image/cover.jpg"]!==void 0)return await t.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(a=>h.read(a)).then(a=>a.getPixelColor(50,500)).then(a=>r==="hex"?"#"+a.toString(16).slice(0,6):h.intToRGBA(a))}u(I,"getCoverColor");const U={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function W(e,r={}){return Z(r).turndown(e)}u(W,"toMarkdown");function Z(e={}){const r={...U,blankReplacement:(a,n)=>n.isBlock&&!n.matches("figure")?`

`:n.outerHTML,...e},t=new S(r);return t.remove("title"),t.addRule("listItem",{filter:"li",replacement:(a,n,o)=>{a=a.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let i=o.bulletListMarker+" ";const c=n.parentNode;if(c.nodeName==="OL"){const l=c.getAttribute("start"),p=Array.prototype.indexOf.call(c.children,n);i=(l?Number(l)+p:p+1)+". "}return i+a+(n.nextSibling&&!/\n$/.test(a)?`
`:"")}}),t.addRule("aba-figure",{filter:"figure",replacement:function(a,n){const o=n.firstChild.firstChild.firstChild,i=o.getAttribute("src"),c=o.getAttribute("alt"),l=n.firstChild.children[1].textContent;return`![${c}](${i} "${l}")`}}),t}u(Z,"toMarkdownParser");async function K(e){const r=A.load(e),t=new Map;r("a[href]").each((o,i)=>{const c=r(i).attr("href");c&&t.set(c,void 0)});const a=[];for(const o of t.keys())o.includes("bkaprt.com")&&a.push(Q(o));const n=[];for(const o of await C(a,{concurrency:1}))o.isFulfilled&&n.push(o.value);return n}u(K,"expandLinks");async function Q(e){const r=new URL(e);return r.protocol="https:",await B(e).get().notFound(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"not found"})).unauthorized(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"unauthorized"})).forbidden(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"forbidden"})).timeout(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"timeout"})).res(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.statusText})).catch(t=>(console.log(t),{requested:e,redirected:t.response?.url?t.response.url:t.url,status:t.response?.status?t.response?.status:t.status,statusText:t.response?.statusText?t.response.statusText:t.text??t.message}))}u(Q,"expand");const V={data:"./output",images:"./output/image",chapters:"./output/src",fonts:!1,expandLinks:!0};async function X(e,r={}){const t={...V,...r},a=await f(e);if(t.data){const n=await w(a),o=await I(a,"hex");d.dir(t.data).write("meta.json",{color:o,...n})}if(t.chapters){const n=[],o=await y(a);for(const i of o){if(i.content.indexOf("#")>-1)continue;const c=await z(a,i.content);if(c){const l={title:i.navLabel,order:i.playOrder};t.expandLinks&&n.push(...await K(c));const p=W(c),k=i.content.replace(".xhtml",".md");d.dir(t.chapters).write(k,T.stringify({content:p},l))}t.data&&n.length&&d.dir(t.data).write("links.json",n)}}t.images&&await v(a,{matching:"**/image/*.*",preserveDates:!0,rewritePaths:n=>n.replace("OEBPS/image/",""),output:t.images})}u(X,"processBook"),exports.copyFiles=v,exports.getChapter=z,exports.getMeta=w,exports.getRawMeta=x,exports.getRawToc=b,exports.getToc=y,exports.listContents=E,exports.loadBook=f,exports.processBook=X;
