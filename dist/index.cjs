"use strict";var S=Object.defineProperty;var u=(a,i)=>S(a,"name",{value:i,configurable:!0});var $=require("jszip"),m=require("fs-jetpack"),w=require("xml2js"),s=require("zod"),M=require("turndown"),R=require("cheerio"),y=require("micromatch"),B=require("utimes"),E=require("gray-matter"),v=require("jimp");function T(a){var i=Object.create(null);return a&&Object.keys(a).forEach(function(r){if(r!=="default"){var t=Object.getOwnPropertyDescriptor(a,r);Object.defineProperty(i,r,t.get?t:{enumerable:!0,get:function(){return a[r]}})}}),i.default=a,Object.freeze(i)}u(T,"_interopNamespaceDefault");var I=T(R);async function p(a){if(typeof a=="string"){const i=await m.readAsync(a,"buffer").then(r=>{if(r)return $.loadAsync(r)});if(i===void 0)throw new Error("EBook file could not be read");return i}else return a}u(p,"loadBook");async function h(a){return await p(a).then(i=>Object.keys(i.files))}u(h,"listContents");const D=w.Parser;async function z(a){const i=await x(a),t=await new D({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[n=>n.startsWith("dc:")?n.replace("dc:",""):n]}).parseStringPromise(i),e=q.safeParse(t);if(e.success)return e.data.package.metadata;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(z,"getMeta");async function x(a){return await p(a).then(i=>i.files["OEBPS/content.opf"]?.async("string"))}u(x,"getRawMeta");const g=s.z.string().or(s.z.object({text:s.z.string()}).transform(a=>a.text)),L=s.z.object({title:g.optional(),creator:s.z.array(g).or(g).optional(),contributor:s.z.array(g).optional().optional(),publisher:s.z.string().optional(),rights:s.z.string().optional(),subject:s.z.string().or(s.z.array(s.z.string())).optional(),language:g.or(s.z.array(g)).optional(),identifier:g,source:s.z.string().optional(),date:s.z.string()}),q=s.z.object({package:s.z.object({metadata:L})}),_=w.Parser;async function b(a){const i=await P(a),t=await new _({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(i),e=J.safeParse(t);if(e.success)return e.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(b,"getToc");async function P(a){return await p(a).then(i=>i.files["OEBPS/toc.ncx"]?.async("string"))}u(P,"getRawToc");const F=s.z.string().or(s.z.object({text:s.z.string()}).transform(a=>a.text)),G=s.z.string().or(s.z.object({src:s.z.string()}).transform(a=>a.src)),H=s.z.object({id:s.z.string(),playOrder:s.z.coerce.number(),navLabel:F,content:G}),J=s.z.object({ncx:s.z.object({navMap:s.z.object({navPoint:s.z.array(H)})})}),V={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function U(a,i={}){return W(i).turndown(a).trim()}u(U,"toMarkdown");function W(a={}){const i={...V,blankReplacement:(t,e)=>e.isBlock&&!e.matches("figure")?`

`:!e.isBlock&&!e.children?.length&&e.textContent.trim()===""?"":e.outerHTML,...a},r=new M(i);return r.remove("title"),r.addRule("listItem",{filter:"li",replacement:(t,e,n)=>{t=t.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let o=n.bulletListMarker+" ";const c=e.parentNode;if(c.nodeName==="OL"){const l=c.getAttribute("start"),f=Array.prototype.indexOf.call(c.children,e);o=(l?Number(l)+f:f+1)+". "}return o+t+(e.nextSibling&&!/\n$/.test(t)?`
`:"")}}),r.addRule("aba-figure-1",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,o=n?.getAttribute&&n?.getAttribute("src"),c=n?.getAttribute&&n?.getAttribute("alt"),l=e.textContent;return o&&l?`![${c}](${o} "${l}")

`:e.outerHTML}}),r.addRule("aba-figure-2",{filter:function(t){const e=t.firstChild,n=e?.getAttribute&&e?.getAttribute("class");return t.nodeName==="FIGURE"&&e.nodeName==="DIV"&&n&&n.indexOf("figure")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,o=n?.getAttribute&&n?.getAttribute("src"),c=n?.getAttribute&&n?.getAttribute("alt"),l=e.firstChild.children[1]?.textContent;return o&&l?`![${c}](${o} "${l}")`:e.outerHTML}}),r.addRule("aba-figure-3",{filter:function(t){const e=t.getAttribute("class"),n=t.children[0],o=t.children[1];return t.nodeName==="DIV"&&e&&e.indexOf("figure")!==-1&&n?.nodeName==="DIV"&&n?.firstChild?.nodeName==="IMG"&&o?.nodeName==="DIV"&&o?.firstChild?.nodeName==="P"},replacement:function(t,e){const n=e.children[0]?.firstChild,o=n?.getAttribute&&n?.getAttribute("src"),c=n?.getAttribute&&n?.getAttribute("alt"),l=e.children[1]?.textContent;return o&&l?`![${c}](${o} "${l}")`:e.outerHTML}}),r.addRule("aba-pre-code",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1},replacement:function(t){return"    "+t+`
`}}),r.addRule("nobreak spans",{filter:function(t){return t.nodeName==="SPAN"&&t.getAttribute("class")==="NoBreak"},replacement:t=>t.trim()}),r.addRule("cite",{filter:"cite",replacement:function(t){return"*"+t+"*"}}),r.remove(t=>t.nodeName==="SPAN"&&t.textContent===" "),r}u(W,"toMarkdownParser");async function A(a,i){const r={},t=await C(a,i);if(t){r.markup=t;const e=I.load(t),n=e("title").text();n&&!i.startsWith(n)&&(r.title=n);const o=e("h1").text();o&&(r.heading=o,e("h1").remove());const c=e("div.chapterheading img, div.ch_open_img img");c&&(r.chapterImage=c?.attr("src")||void 0,e(c).remove()),r.links??=[],e('a[href^="http"]').each((l,f)=>{const d=e(f)?.attr("href");d&&r.links?.push(d)}),r.markdown=U(e.html())}return r}u(A,"getChapter");async function C(a,i){const r=await p(a);if(r.files[`OEBPS/${i}`]!==void 0)return await r.files[`OEBPS/${i}`].async("string")}u(C,"getRawChapter");const Z={output:"./output",preserveDates:!0};async function k(a,i={}){const r={...Z,...i},t=await p(a);let e=Object.keys(t.files);r.matching!==void 0&&(e=e.filter(o=>y.isMatch(o,r.matching)));const n=m.dir(r.output??".");for(const o of e){const c=t.file(o);if(c){const l=r.rewritePaths?r.rewritePaths(o):o,f=await c.async("nodebuffer");n.write(l,f),r.preserveDates&&await B.utimes(n.path(l),{btime:c.date,mtime:c.date})}}}u(k,"copyFiles");async function K(a,i="rgba"){const r=await p(a);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(t=>v.read(t)).then(t=>t.getPixelColor(50,500)).then(t=>i==="hex"?"#"+t.toString(16).slice(0,6):v.intToRGBA(t))}u(K,"getCoverColor");const Q={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image/*.*",convertToMarkdown:!0,resolveLinks:!0};async function X(a,i={}){const r={...Q,...i},t=await p(a),e=m.dir(r.root);if(r.data){const n=await z(t),o=await K(t,"hex");e.dir(r.data).write("meta.json",{color:o,...n}),e.dir(r.data).write("files.json",await h(t)),e.dir(r.data).write("toc.json",await b(t))}if(r.chapters){const n=await b(t);let o=r.useToc?n.map(c=>c.content):(await h(t)).filter(c=>y.isMatch(c,r.chapterPattern));o=o.map(c=>c.split("#")[0]),o=[...new Set(o).values()];for(const c of o){const l=await A(t,c);if(l.markup){const f={};l.title&&(f.title=l.title),l.heading&&(f.heading=l.heading),l.order&&(f.order=l.order),l.chapterImage&&(f.headerImage=l.chapterImage);const d=n.find(N=>N.content===c);d&&(d.playOrder&&(f.order=d.playOrder),d.navLabel&&(f.title??=d.navLabel));const O=l.markdown??"",j=c.replace(/\..?html/,".md");e.dir(r.chapters).write(j,E.stringify(O,f))}}}r.images&&await k(t,{matching:r.assetPattern,preserveDates:!0,rewritePaths:n=>n.replace("OEBPS/image/",""),output:e.dir(r.images).path()})}u(X,"processBook"),exports.copyFiles=k,exports.getChapter=A,exports.getMeta=z,exports.getRawChapter=C,exports.getRawMeta=x,exports.getRawToc=P,exports.getToc=b,exports.listContents=h,exports.loadBook=p,exports.processBook=X;
