"use strict";var j=Object.defineProperty;var u=(n,i)=>j(n,"name",{value:i,configurable:!0});var O=require("jszip"),d=require("fs-jetpack"),m=require("xml2js"),s=require("zod"),N=require("turndown"),$=require("cheerio"),S=require("micromatch"),B=require("utimes"),R=require("gray-matter"),h=require("jimp");function M(n){var i=Object.create(null);return n&&Object.keys(n).forEach(function(r){if(r!=="default"){var t=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(i,r,t.get?t:{enumerable:!0,get:function(){return n[r]}})}}),i.default=n,Object.freeze(i)}u(M,"_interopNamespaceDefault");var E=M($);async function p(n){if(typeof n=="string"){const i=await d.readAsync(n,"buffer").then(r=>{if(r)return O.loadAsync(r)});if(i===void 0)throw new Error("EBook file could not be read");return i}else return n}u(p,"loadBook");async function D(n){return await p(n).then(i=>Object.keys(i.files))}u(D,"listContents");const L=m.Parser;async function b(n){const i=await w(n),t=await new L({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[e=>e.startsWith("dc:")?e.replace("dc:",""):e]}).parseStringPromise(i);return q.parse(t).package.metadata}u(b,"getMeta");async function w(n){return await p(n).then(i=>i.files["OEBPS/content.opf"]?.async("string"))}u(w,"getRawMeta");const g=s.z.string().or(s.z.object({text:s.z.string()}).transform(n=>n.text)),T=s.z.object({title:s.z.string(),creator:s.z.array(g).or(g).optional(),contributor:s.z.array(g).optional().optional(),publisher:s.z.string().optional(),rights:s.z.string().optional(),subject:s.z.array(s.z.string()).optional(),language:s.z.string(),identifier:g,source:s.z.string().optional(),date:s.z.string()}),q=s.z.object({package:s.z.object({metadata:T})}),H=m.Parser;async function y(n){const i=await x(n),t=await new H({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(i);return G.parse(t).ncx.navMap.navPoint}u(y,"getToc");async function x(n){return await p(n).then(i=>i.files["OEBPS/toc.ncx"]?.async("string"))}u(x,"getRawToc");const I=s.z.string().or(s.z.object({text:s.z.string()}).transform(n=>n.text)),F=s.z.string().or(s.z.object({src:s.z.string()}).transform(n=>n.src)),_=s.z.object({id:s.z.string(),playOrder:s.z.coerce.number(),navLabel:I,content:F}),G=s.z.object({ncx:s.z.object({navMap:s.z.object({navPoint:s.z.array(_)})})}),V={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function J(n,i={}){return U(i).turndown(n)}u(J,"toMarkdown");function U(n={}){const i={...V,blankReplacement:(t,e)=>e.isBlock&&!e.matches("figure")?`

`:!e.isBlock&&e.matches("span")&&e.textContent.trim()===""?"":e.outerHTML,...n},r=new N(i);return r.remove("title"),r.addRule("listItem",{filter:"li",replacement:(t,e,a)=>{t=t.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let o=a.bulletListMarker+" ";const l=e.parentNode;if(l.nodeName==="OL"){const c=l.getAttribute("start"),f=Array.prototype.indexOf.call(l.children,e);o=(c?Number(c)+f:f+1)+". "}return o+t+(e.nextSibling&&!/\n$/.test(t)?`
`:"")}}),r.addRule("aba-figure-1",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(t,e){const a=e.firstChild?.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),l=a?.getAttribute&&a?.getAttribute("alt"),c=e.textContent;return o&&c?`![${l}](${o} "${c}")

`:e.outerHTML}}),r.addRule("aba-figure-2",{filter:function(t){const e=t.firstChild,a=e?.getAttribute&&e?.getAttribute("class");return t.nodeName==="FIGURE"&&e.nodeName==="DIV"&&a&&a.indexOf("figure")!==-1},replacement:function(t,e){const a=e.firstChild?.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),l=a?.getAttribute&&a?.getAttribute("alt"),c=e.firstChild.children[1]?.textContent;return o&&c?`![${l}](${o} "${c}")`:e.outerHTML}}),r.addRule("aba-figure-3",{filter:function(t){const e=t.getAttribute("class"),a=t.children[0],o=t.children[1];return t.nodeName==="DIV"&&e&&e.indexOf("figure")!==-1&&a?.nodeName==="DIV"&&a?.firstChild?.nodeName==="IMG"&&o?.nodeName==="DIV"&&o?.firstChild?.nodeName==="P"},replacement:function(t,e){const a=e.children[0]?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),l=a?.getAttribute&&a?.getAttribute("alt"),c=e.children[1]?.textContent;return o&&c?`![${l}](${o} "${c}")`:e.outerHTML}}),r.addRule("aba-pre-code",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1},replacement:function(t){return"    "+t+`
`}}),r.addRule("nobreak spans",{filter:function(t){return t.nodeName==="SPAN"&&console.log(t.textContent),t.nodeName==="SPAN"&&t.getAttribute("class")==="NoBreak"},replacement:t=>t.trim()}),r.remove(t=>t.nodeName==="SPAN"&&t.textContent===" "),r}u(U,"toMarkdownParser");async function v(n,i){const r={},t=await z(n,i);if(t){r.xhtml=t;const e=E.load(t),a=e("title");a&&(r.title=a?.text()||void 0,e(a).remove());const o=e("div.chapterheading img");o&&(r.chapterHeading=o?.attr("src")||void 0,e(o).remove()),r.links??=[],e('a[href^="http"]').each((l,c)=>{const f=e(c)?.attr("href");f&&r.links?.push(f)}),r.markdown=J(e.html())}return r}u(v,"getChapter");async function z(n,i){const r=await p(n);if(r.files[`OEBPS/${i}`]!==void 0)return await r.files[`OEBPS/${i}`].async("string")}u(z,"getRawChapter");const W={output:"./output",preserveDates:!0};async function A(n,i={}){const r={...W,...i},t=await p(n);let e=Object.keys(t.files);r.matching!==void 0&&(e=e.filter(o=>S.isMatch(o,r.matching)));const a=d.dir(r.output??".");for(const o of e){const l=t.file(o);if(l){const c=r.rewritePaths?r.rewritePaths(o):o,f=await l.async("nodebuffer");a.write(c,f),r.preserveDates&&await B.utimes(a.path(c),{btime:l.date,mtime:l.date})}}}u(A,"copyFiles");async function Z(n,i="rgba"){const r=await p(n);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(t=>h.read(t)).then(t=>t.getPixelColor(50,500)).then(t=>i==="hex"?"#"+t.toString(16).slice(0,6):h.intToRGBA(t))}u(Z,"getCoverColor");const K={root:"./output",data:"_data",images:"_static/image",chapters:"_src",fonts:!1,expandLinks:!0};async function Q(n,i={}){const r={...K,...i},t=await p(n),e=d.dir(r.root);if(r.data){const a=await b(t),o=await Z(t,"hex");e.dir(r.data).write("meta.json",{color:o,...a})}if(r.chapters){const a=[],o=await y(t);for(const l of o){if(l.content.indexOf("#")>-1)continue;const c=await v(t,l.content);if(c.xhtml){const f={title:l.navLabel,order:l.playOrder};c.chapterHeading&&(f.chapterHeading=c.chapterHeading),r.expandLinks&&a.push(...c.links?.map(P=>({url:P}))??[]);const C=c.markdown??"",k=l.content.replace(".xhtml",".md");e.dir(r.chapters).write(k,R.stringify({content:C},f))}r.data&&a.length&&e.dir(r.data).write("links.json",a)}}r.images&&await A(t,{matching:"**/image/*.*",preserveDates:!0,rewritePaths:a=>a.replace("OEBPS/image/",""),output:e.dir(r.images).path()})}u(Q,"processBook"),exports.copyFiles=A,exports.getChapter=v,exports.getMeta=b,exports.getRawChapter=z,exports.getRawMeta=w,exports.getRawToc=x,exports.getToc=y,exports.listContents=D,exports.loadBook=p,exports.processBook=Q;
