"use strict";var D=Object.defineProperty;var s=(t,e)=>D(t,"name",{value:e,configurable:!0});var F=require("jszip"),w=require("fs-jetpack"),N=require("xml2js"),c=require("zod"),q=require("turndown"),H=require("cheerio"),x=require("micromatch"),_=require("utimes"),G=require("gray-matter"),k=require("jimp");function J(t){var e=Object.create(null);return t&&Object.keys(t).forEach(function(r){if(r!=="default"){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}}),e.default=t,Object.freeze(e)}s(J,"_interopNamespaceDefault");var V=J(H);async function d(t){if(typeof t=="string"){const e=await w.readAsync(t,"buffer").then(r=>{if(r)return F.loadAsync(r)});if(e===void 0)throw new Error("EBook file could not be read");return e}else return t}s(d,"loadBook");async function C(t){return await d(t).then(e=>Object.keys(e.files))}s(C,"listContents");const U=N.Parser;async function z(t){const e=await S(t),n=await new U({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[o=>o.startsWith("dc:")?o.replace("dc:",""):o]}).parseStringPromise(e),i=Y.safeParse(n);if(i.success)return i.data.package.metadata;throw console.log(JSON.stringify(n,void 0,2)),i.error}s(z,"getMeta");async function S(t){return await d(t).then(e=>e.files["OEBPS/content.opf"]?.async("string"))}s(S,"getRawMeta");const m=c.z.string().or(c.z.object({text:c.z.string()}).transform(t=>t.text)),W=c.z.object({title:m.optional(),creator:c.z.array(m).or(m).optional(),contributor:c.z.array(m).optional().optional(),publisher:c.z.string().optional(),rights:c.z.string().optional(),subject:c.z.string().or(c.z.array(c.z.string())).optional(),language:m.or(c.z.array(m)).optional(),identifier:m,source:c.z.string().optional(),date:c.z.string()}),Y=c.z.object({package:c.z.object({metadata:W})}),Z=N.Parser;async function y(t){const e=await P(t),n=await new Z({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(e),i=tt.safeParse(n);if(i.success)return i.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(n,void 0,2)),i.error}s(y,"getToc");async function P(t){return await d(t).then(e=>e.files["OEBPS/toc.ncx"]?.async("string"))}s(P,"getRawToc");const K=c.z.string().or(c.z.object({text:c.z.string()}).transform(t=>t.text)),Q=c.z.string().or(c.z.object({src:c.z.string()}).transform(t=>t.src)),X=c.z.object({id:c.z.string(),playOrder:c.z.coerce.number(),navLabel:K,content:Q}),tt=c.z.object({ncx:c.z.object({navMap:c.z.object({navPoint:c.z.array(X)})})}),et=Array.prototype.indexOf,rt=Array.prototype.every,h={},nt={left:":--",right:"--:",center:":-:"};h.tableCell={filter:["th","td"],replacement:function(t,e){return A(T(e))?t:v(t,e)}},h.tableRow={filter:"tr",replacement:function(t,e){const r=T(e);if(A(r))return t;let n="";if(it(e)){const i=B(r);for(let o=0;o<i;o++){const a=i>=e.childNodes.length?null:e.childNodes[o];let l="---";const u=a?(a.getAttribute("align")||"").toLowerCase():"";u&&(l=nt[u]||l),a?n+=v(l,e.childNodes[o]):n+=v(l,null,o)}}return`
`+t+(n?`
`+n:"")}},h.table={filter:function(t){return t.nodeName==="TABLE"},replacement:function(t,e){if(A(e))return t;t=t.replace(/\n+/g,`
`);let r;at(e.firstChild)&&(r=e.firstChild.textContent,e.firstChild.remove());let n=t.trim().split(`
`);n.length>=2&&(n=[n[1]]);const i=n[0].indexOf("| ---")===0,o=B(e);let a="";return o&&!i&&(a="|"+"     |".repeat(o)+`
|`+" --- |".repeat(o)),r?`

`+r+`

`+a+t+`

`:`

`+a+t+`

`}},h.tableSection={filter:["thead","tbody","tfoot"],replacement:function(t){return t}};function it(t){const e=t.parentNode;return e.nodeName==="THEAD"||e.firstChild===t&&(e.nodeName==="TABLE"||ot(e))&&rt.call(t.childNodes,function(r){return r.nodeName==="TH"})}s(it,"isHeadingRow");function at(t){return t.parentNode.nodeName==="TABLE"&&t.nodeName==="CAPTION"}s(at,"isTableCaption");function ot(t){const e=t.previousSibling;return t.nodeName==="TBODY"&&(!e||e.nodeName==="THEAD"&&/^\s*$/i.test(e.textContent))}s(ot,"isFirstTbody");function v(t,e,r){r===null&&(r=et.call(e.parentNode.childNodes,e));let n=" ";r===0&&(n="| ");let i=t.trim().replace(/\n\r/g,"<br>").replace(/\n/g,"<br>");for(i=i.replace(/\|+/g,"\\|");i.length<3;)i+=" ";return e&&(i=st(i,e," ")),n+i+" |"}s(v,"cell");function O(t){if(!t.childNodes)return!1;for(let e=0;e<t.childNodes.length;e++){const r=t.childNodes[e];if(r.nodeName==="TABLE"||O(r))return!0}return!1}s(O,"nodeContainsTable");function A(t){return!!(!t||!t.rows||t.rows.length===1&&t.rows[0].childNodes.length<=1||O(t))}s(A,"tableShouldBeSkipped");function T(t){let e=t.parentNode;for(;e.nodeName!=="TABLE";)if(e=e.parentNode,!e)return null;return e}s(T,"nodeParentTable");function st(t,e,r){const n=e.getAttribute("colspan")||1;for(let i=1;i<n;i++)t+=" | "+r.repeat(3);return t}s(st,"handleColSpan");function B(t){let e=0;for(let r=0;r<t.rows.length;r++){const i=t.rows[r].childNodes.length;i>e&&(e=i)}return e}s(B,"tableColCount");function ct(t){t.keep(function(e){return e.nodeName==="TABLE"}),t.remove("caption");for(const e in h)t.addRule(e,h[e])}s(ct,"tables");function lt(t){t.addRule("nobreak spans",{filter:function(e){return e.nodeName==="SPAN"&&e.getAttribute("class")==="NoBreak"},replacement:e=>e.trim()})}s(lt,"abaNobrSpans");function ut(t){t.addRule("aba-figure-1",{filter:function(e){const r=e.getAttribute("class");return e.nodeName==="FIGURE"&&r&&r.indexOf("figFrame")!==-1},replacement:function(e,r){const n=r.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.textContent;return i&&a?`![${o||""}](${i} "${a}")

`:a&&!i?`![${o||""}](image/missing-image.png "${a}")

`:r.outerHTML}}),t.addRule("aba-figure-2",{filter:function(e){const r=e.firstChild,n=r?.getAttribute&&r?.getAttribute("class");return e.nodeName==="FIGURE"&&r.nodeName==="DIV"&&n&&n.indexOf("figure")!==-1},replacement:function(e,r){const n=r.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.firstChild.children[1]?.textContent;return i&&a?`![${o||""}](${i} "${a}")`:r.outerHTML}}),t.addRule("aba-figure-3",{filter:function(e){const r=e.getAttribute("class"),n=e.children[0],i=e.children[1];return e.nodeName==="DIV"&&r&&r.indexOf("figure")!==-1&&n?.nodeName==="DIV"&&n?.firstChild?.nodeName==="IMG"&&i?.nodeName==="DIV"&&i?.firstChild?.nodeName==="P"},replacement:function(e,r){const n=r.children[0]?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.children[1]?.textContent;return i&&a?`![${o||""}](${i} "${a}")`:r.outerHTML}}),t.addRule("aba-figure-4",{filter:function(e){const r=e.getAttribute("class");return e.nodeName==="FIGURE"&&r&&r.indexOf("figFrame")!==-1},replacement:function(e,r){const n=r.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.textContent;return i&&a?`![${o||""}](${i} "${a}")

`:a&&!i?`![${o||""}](image/missing-image.png "${a}")

`:r.outerHTML}})}s(ut,"abaFigures");const $={};function ft(t){t.addRule("aba-pre-code",$.abaCode)}s(ft,"abaCodeBlocks");function p(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1}s(p,"isAbaCodeBlock");function pt(t){return!(!p(t)||t.previousSibling&&p(t.previousSibling)||!(t.nextSibling&&p(t.nextSibling)))}s(pt,"isOpeningCodeBlock");function gt(t){return!(!p(t)||!(t.previousSibling&&p(t.previousSibling))||t.nextSibling&&p(t.nextSibling))}s(gt,"isFinalCodeBlock");function dt(t){return!(!p(t)||!(t.previousSibling&&p(t.previousSibling))||!(t.nextSibling&&p(t.nextSibling)))}s(dt,"isMidCodeBlock"),$.abaCode={filter:function(t){return p(t)},replacement:function(t,e,r){return e.isCode=!0,t?(t=t.replace(/\r?\n|\r/g," "),pt(e)?`
`+r.fence+`
`+t+`
`:dt(e)?t+`
`:gt(e)?t+`
`+r.fence+`

`:t):""}};function mt(t){t.addRule("listItem",{filter:"li",replacement:(e,r,n)=>{e=e.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let i=n.bulletListMarker+" ";const o=r.parentNode;if(o?.nodeName==="OL"){const a=o.getAttribute("start"),l=Array.prototype.indexOf.call(o.children,r);i=(a?Number(a)+l:l+1)+". "}return i+e+(r.nextSibling&&!/\n$/.test(e)?`
`:"")}})}s(mt,"noIndentListItem");const ht={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function bt(t,e={}){return wt(e).turndown(t).trim()}s(bt,"toMarkdown");function wt(t={}){const e={...ht,blankReplacement:(n,i)=>i.isBlock&&!i.matches("figure")?`

`:!i.isBlock&&!i.children?.length&&i.textContent?.trim()===""?"":i.outerHTML,...t},r=new q(e).use([ct,lt,ut,ft,mt]);return r.remove("title"),r.addRule("cite",{filter:"cite",replacement:function(n){return"*"+n+"*"}}),r.remove(n=>n.nodeName==="SPAN"&&n.textContent===" "),r}s(wt,"toMarkdownParser");async function j(t,e){const r={},n=await E(t,e);if(n){r.markup=n;const i=V.load(n),o=i("title").text();o&&!e.startsWith(o)&&(r.title=o);const a=i("h1").text();a&&(r.title??=a,i("h1").remove());const l=i("div.chapterheading img, div.ch_open_img img");l&&(r.chapterImage=l?.attr("src")||void 0,i(l).remove()),r.links??=[],i('a[href^="http"]').each((u,f)=>{const g=i(f)?.attr("href");g&&r.links?.push(g)}),r.markdown=bt(i.html())}return r}s(j,"getChapter");async function E(t,e){const r=await d(t);if(r.files[`OEBPS/${e}`]!==void 0)return await r.files[`OEBPS/${e}`].async("string")}s(E,"getRawChapter");const Ct={output:"./output",preserveDates:!0};async function R(t,e={}){const r={...Ct,...e},n=await d(t);let i=Object.keys(n.files);r.matching!==void 0&&(i=i.filter(a=>x.isMatch(a,r.matching)));const o=w.dir(r.output??".");for(const a of i){const l=n.file(a);if(l){const u=r.rewritePaths?r.rewritePaths(a):a,f=await l.async("nodebuffer");o.write(u,f),r.preserveDates&&await _.utimes(o.path(u),{btime:l.date,mtime:l.date})}}}s(R,"copyFiles");async function yt(t,e="rgba"){const r=await d(t);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(n=>k.read(n)).then(n=>n.getPixelColor(50,500)).then(n=>e==="hex"?"#"+n.toString(16).slice(0,6):k.intToRGBA(n))}s(yt,"getCoverColor");const vt={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image*/*.*",convertToMarkdown:!0,resolveLinks:!0};async function At(t,e={}){const r={...vt,...e},n=await d(t),i=w.dir(r.root);if(r.data){const o=await z(n),a=await yt(n,"hex");i.dir(r.data).write("meta.json",{color:a,...o}),i.dir(r.data).write("files.json",await C(n)),i.dir(r.data).write("toc.json",await y(n))}if(r.chapters){const o=await y(n);let a=r.useToc?o.map(u=>u.content):(await C(n)).filter(u=>x.isMatch(u,r.chapterPattern));a=a.map(u=>u.split("#")[0]),a=[...new Set(a).values()];let l=0;for(const u of a){const f=await j(n,u);if(f.markup){const g={};f.title&&(g.title=f.title.replace(/Chapter \d+\.\s*/,"")),f.chapterImage&&(g.headerImage=f.chapterImage,g.chapterNumber=++l);const b=o.find(I=>I.content===u);b&&(b.playOrder&&(g.tocOrder=b.playOrder),b.navLabel&&(g.title??=b.navLabel));const L=f.markdown??"",M=u.replace(/\..?html/,".md");i.dir(r.chapters).write(M,G.stringify(L,g))}}}r.images&&await R(n,{matching:r.assetPattern,preserveDates:!0,rewritePaths:o=>o.replace("OEBPS/image/",""),output:i.dir(r.images).path()})}s(At,"processBook"),exports.copyFiles=R,exports.getChapter=j,exports.getMeta=z,exports.getRawChapter=E,exports.getRawMeta=S,exports.getRawToc=P,exports.getToc=y,exports.listContents=C,exports.loadBook=d,exports.processBook=At;
