"use strict";var C=Object.defineProperty;var u=(e,a)=>C(e,"name",{value:a,configurable:!0});var B=require("jszip"),g=require("fs-jetpack"),m=require("xml2js"),i=require("zod"),S=require("turndown"),M=require("cheerio"),$=require("micromatch"),A=require("utimes"),E=require("gray-matter"),h=require("jimp");function q(e){var a=Object.create(null);return e&&Object.keys(e).forEach(function(t){if(t!=="default"){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(a,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})}}),a.default=e,Object.freeze(a)}u(q,"_interopNamespaceDefault");var R=q(M);async function p(e){if(typeof e=="string"){const a=await g.readAsync(e,"buffer").then(t=>{if(t)return B.loadAsync(t)});if(a===void 0)throw new Error("EBook file could not be read");return a}else return e}u(p,"loadBook");async function L(e){return await p(e).then(a=>Object.keys(a.files))}u(L,"listContents");const T=m.Parser;async function w(e){const a=await y(e),r=await new T({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[n=>n.startsWith("dc:")?n.replace("dc:",""):n]}).parseStringPromise(a);return H.parse(r).package.metadata}u(w,"getMeta");async function y(e){return await p(e).then(a=>a.files["OEBPS/content.opf"]?.async("string"))}u(y,"getRawMeta");const d=i.z.string().or(i.z.object({text:i.z.string()}).transform(e=>e.text)),D=i.z.object({title:i.z.string(),creator:i.z.array(d).or(d).optional(),contributor:i.z.array(d).optional().optional(),publisher:i.z.string().optional(),rights:i.z.string().optional(),subject:i.z.array(i.z.string()).optional(),language:i.z.string(),identifier:d,source:i.z.string().optional(),date:i.z.string()}),H=i.z.object({package:i.z.object({metadata:D})}),_=m.Parser;async function v(e){const a=await b(e),r=await new _({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(a);return G.parse(r).ncx.navMap.navPoint}u(v,"getToc");async function b(e){return await p(e).then(a=>a.files["OEBPS/toc.ncx"]?.async("string"))}u(b,"getRawToc");const N=i.z.string().or(i.z.object({text:i.z.string()}).transform(e=>e.text)),F=i.z.string().or(i.z.object({src:i.z.string()}).transform(e=>e.src)),J=i.z.object({id:i.z.string(),playOrder:i.z.coerce.number(),navLabel:N,content:F}),G=i.z.object({ncx:i.z.object({navMap:i.z.object({navPoint:i.z.array(J)})})}),I={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function W(e,a={}){return Z(a).turndown(e)}u(W,"toMarkdown");function Z(e={}){const a={...I,blankReplacement:(r,n)=>n.isBlock&&!n.matches("figure")?`

`:n.outerHTML,...e},t=new S(a);return t.remove("title"),t.addRule("listItem",{filter:"li",replacement:(r,n,o)=>{r=r.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let s=o.bulletListMarker+" ";const c=n.parentNode;if(c.nodeName==="OL"){const l=c.getAttribute("start"),f=Array.prototype.indexOf.call(c.children,n);s=(l?Number(l)+f:f+1)+". "}return s+r+(n.nextSibling&&!/\n$/.test(r)?`
`:"")}}),t.addRule("aba-figure",{filter:"figure",replacement:function(r,n){const o=n.firstChild?.firstChild?.firstChild,s=o?o.getAttribute("src"):void 0,c=o?o.getAttribute("alt"):void 0,l=n.firstChild?.children[1]?.textContent;return s&&l?`![${c}](${s} "${l}")`:n.outerHTML}}),t}u(Z,"toMarkdownParser");async function z(e,a){const t={},r=await x(e,a);if(r){t.xhtml=r;const n=R.load(r),o=n("title");o&&(t.title=o?.text()||void 0,n(o).remove());const s=n("div.chapterheading img");s&&(t.chapterHeading=s?.attr("src")||void 0,n(s).remove()),t.links??=[],n('a[href^="http"]').each((c,l)=>{const f=n(l)?.attr("href");f&&t.links?.push(f)}),t.markdown=W(n.html())}return t}u(z,"getChapter");async function x(e,a){const t=await p(e);if(t.files[`OEBPS/${a}`]!==void 0)return await t.files[`OEBPS/${a}`].async("string")}u(x,"getRawChapter");const K={output:"./output",preserveDates:!0};async function k(e,a={}){const t={...K,...a},r=await p(e);let n=Object.keys(r.files);t.matching!==void 0&&(n=n.filter(s=>$.isMatch(s,t.matching)));const o=g.dir(t.output??".");for(const s of n){const c=r.file(s);if(c){const l=t.rewritePaths?t.rewritePaths(s):s,f=await c.async("nodebuffer");o.write(l,f),t.preserveDates&&await A.utimes(o.path(l),{btime:c.date,mtime:c.date})}}}u(k,"copyFiles");async function Q(e,a="rgba"){const t=await p(e);if(t.files["OEBPS/image/cover.jpg"]!==void 0)return await t.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(r=>h.read(r)).then(r=>r.getPixelColor(50,500)).then(r=>a==="hex"?"#"+r.toString(16).slice(0,6):h.intToRGBA(r))}u(Q,"getCoverColor");const U={root:"./output",data:"_data",images:"_static/image",chapters:"_src",fonts:!1,expandLinks:!0};async function V(e,a={}){const t={...U,...a},r=await p(e),n=g.dir(t.root);if(t.data){const o=await w(r),s=await Q(r,"hex");n.dir(t.data).write("meta.json",{color:s,...o})}if(t.chapters){const o=[],s=await v(r);for(const c of s){if(c.content.indexOf("#")>-1)continue;const l=await z(r,c.content);if(l.xhtml){const f={title:l.title??c.navLabel,order:c.playOrder};l.chapterHeading&&(f.chapterHeading=l.chapterHeading),t.expandLinks&&o.push(...l.links?.map(O=>({url:O}))??[]);const j=l.markdown??"",P=c.content.replace(".xhtml",".md");n.dir(t.chapters).write(P,E.stringify({content:j},f))}t.data&&o.length&&n.dir(t.data).write("links.json",o)}}t.images&&await k(r,{matching:"**/image/*.*",preserveDates:!0,rewritePaths:o=>o.replace("OEBPS/image/",""),output:n.dir(t.images).path()})}u(V,"processBook"),exports.copyFiles=k,exports.getChapter=z,exports.getMeta=w,exports.getRawChapter=x,exports.getRawMeta=y,exports.getRawToc=b,exports.getToc=v,exports.listContents=L,exports.loadBook=p,exports.processBook=V;
