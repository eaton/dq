"use strict";var M=Object.defineProperty;var u=(t,n)=>M(t,"name",{value:n,configurable:!0});var D=require("jszip"),b=require("fs-jetpack"),A=require("xml2js"),l=require("zod"),I=require("turndown"),q=require("cheerio"),N=require("micromatch"),H=require("utimes"),F=require("gray-matter"),x=require("jimp");function _(t){var n=Object.create(null);return t&&Object.keys(t).forEach(function(i){if(i!=="default"){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}}),n.default=t,Object.freeze(n)}u(_,"_interopNamespaceDefault");var G=_(q);async function p(t){if(typeof t=="string"){const n=await b.readAsync(t,"buffer").then(i=>{if(i)return D.loadAsync(i)});if(n===void 0)throw new Error("EBook file could not be read");return n}else return t}u(p,"loadBook");async function w(t){return await p(t).then(n=>Object.keys(n.files))}u(w,"listContents");const J=A.Parser;async function z(t){const n=await P(t),r=await new J({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[a=>a.startsWith("dc:")?a.replace("dc:",""):a]}).parseStringPromise(n),e=U.safeParse(r);if(e.success)return e.data.package.metadata;throw console.log(JSON.stringify(r,void 0,2)),e.error}u(z,"getMeta");async function P(t){return await p(t).then(n=>n.files["OEBPS/content.opf"]?.async("string"))}u(P,"getRawMeta");const g=l.z.string().or(l.z.object({text:l.z.string()}).transform(t=>t.text)),V=l.z.object({title:g.optional(),creator:l.z.array(g).or(g).optional(),contributor:l.z.array(g).optional().optional(),publisher:l.z.string().optional(),rights:l.z.string().optional(),subject:l.z.string().or(l.z.array(l.z.string())).optional(),language:g.or(l.z.array(g)).optional(),identifier:g,source:l.z.string().optional(),date:l.z.string()}),U=l.z.object({package:l.z.object({metadata:V})}),W=A.Parser;async function y(t){const n=await O(t),r=await new W({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(n),e=Q.safeParse(r);if(e.success)return e.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(r,void 0,2)),e.error}u(y,"getToc");async function O(t){return await p(t).then(n=>n.files["OEBPS/toc.ncx"]?.async("string"))}u(O,"getRawToc");const Y=l.z.string().or(l.z.object({text:l.z.string()}).transform(t=>t.text)),Z=l.z.string().or(l.z.object({src:l.z.string()}).transform(t=>t.src)),K=l.z.object({id:l.z.string(),playOrder:l.z.coerce.number(),navLabel:Y,content:Z}),Q=l.z.object({ncx:l.z.object({navMap:l.z.object({navPoint:l.z.array(K)})})}),X=Array.prototype.indexOf,tt=Array.prototype.every,m={},et={left:":--",right:"--:",center:":-:"};m.tableCell={filter:["th","td"],replacement:function(t,n){return v(T(n))?t:C(t,n)}},m.tableRow={filter:"tr",replacement:function(t,n){const i=T(n);if(v(i))return t;let r="";if(rt(n)){const e=$(i);for(let a=0;a<e;a++){const o=e>=n.childNodes.length?null:n.childNodes[a];let c="---";const s=o?(o.getAttribute("align")||"").toLowerCase():"";s&&(c=et[s]||c),o?r+=C(c,n.childNodes[a]):r+=C(c,null,a)}}return`
`+t+(r?`
`+r:"")}},m.table={filter:function(t){return t.nodeName==="TABLE"},replacement:function(t,n){if(v(n))return t;t=t.replace(/\n+/g,`
`);let i;nt(n.firstChild)&&(i=n.firstChild.textContent,n.firstChild.remove());let r=t.trim().split(`
`);r.length>=2&&(r=[r[1]]);const e=r.indexOf("| ---")===0,a=$(n);let o="";return a&&!e&&(o="|"+"     |".repeat(a)+`
|`+" --- |".repeat(a)),i?`

`+i+`

`+o+t+`

`:`

`+o+t+`

`}},m.tableSection={filter:["thead","tbody","tfoot"],replacement:function(t){return t}};function rt(t){const n=t.parentNode;return n.nodeName==="THEAD"||n.firstChild===t&&(n.nodeName==="TABLE"||it(n))&&tt.call(t.childNodes,function(i){return i.nodeName==="TH"})}u(rt,"isHeadingRow");function nt(t){return t.parentNode.nodeName==="TABLE"&&t.nodeName==="CAPTION"}u(nt,"isTableCaption");function it(t){const n=t.previousSibling;return t.nodeName==="TBODY"&&(!n||n.nodeName==="THEAD"&&/^\s*$/i.test(n.textContent))}u(it,"isFirstTbody");function C(t,n,i){i===null&&(i=X.call(n.parentNode.childNodes,n));let r=" ";i===0&&(r="| ");let e=t.trim().replace(/\n\r/g,"<br>").replace(/\n/g,"<br>");for(e=e.replace(/\|+/g,"\\|");e.length<3;)e+=" ";return n&&(e=at(e,n," ")),r+e+" |"}u(C,"cell");function k(t){if(!t.childNodes)return!1;for(let n=0;n<t.childNodes.length;n++){const i=t.childNodes[n];if(i.nodeName==="TABLE"||k(i))return!0}return!1}u(k,"nodeContainsTable");function v(t){return!!(!t||!t.rows||t.rows.length===1&&t.rows[0].childNodes.length<=1||k(t))}u(v,"tableShouldBeSkipped");function T(t){let n=t.parentNode;for(;n.nodeName!=="TABLE";)if(n=n.parentNode,!n)return null;return n}u(T,"nodeParentTable");function at(t,n,i){const r=n.getAttribute("colspan")||1;for(let e=1;e<r;e++)t+=" | "+i.repeat(3);return t}u(at,"handleColSpan");function $(t){let n=0;for(let i=0;i<t.rows.length;i++){const e=t.rows[i].childNodes.length;e>n&&(n=e)}return n}u($,"tableColCount");function ot(t){t.keep(function(n){return n.nodeName==="TABLE"}),t.remove("caption");for(const n in m)t.addRule(n,m[n])}u(ot,"tables");const st={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function ct(t,n={}){return lt(n).turndown(t).trim()}u(ct,"toMarkdown");function lt(t={}){const n={...st,blankReplacement:(r,e)=>e.isBlock&&!e.matches("figure")?`

`:!e.isBlock&&!e.children?.length&&e.textContent?.trim()===""?"":e.outerHTML,...t},i=new I(n).use([ot]);return i.remove("title"),i.addRule("listItem",{filter:"li",replacement:(r,e,a)=>{r=r.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let o=a.bulletListMarker+" ";const c=e.parentNode;if(c?.nodeName==="OL"){const s=c.getAttribute("start"),f=Array.prototype.indexOf.call(c.children,e);o=(s?Number(s)+f:f+1)+". "}return o+r+(e.nextSibling&&!/\n$/.test(r)?`
`:"")}}),i.addRule("aba-figure-1",{filter:function(r){const e=r.getAttribute("class");return r.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(r,e){const a=e.firstChild?.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=e.textContent;return o&&s?`![${c||""}](${o} "${s}")

`:s&&!o?`![${c||""}](image/missing-image.png "${s}")

`:e.outerHTML}}),i.addRule("aba-figure-2",{filter:function(r){const e=r.firstChild,a=e?.getAttribute&&e?.getAttribute("class");return r.nodeName==="FIGURE"&&e.nodeName==="DIV"&&a&&a.indexOf("figure")!==-1},replacement:function(r,e){const a=e.firstChild?.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=e.firstChild.children[1]?.textContent;return o&&s?`![${c||""}](${o} "${s}")`:e.outerHTML}}),i.addRule("aba-figure-3",{filter:function(r){const e=r.getAttribute("class"),a=r.children[0],o=r.children[1];return r.nodeName==="DIV"&&e&&e.indexOf("figure")!==-1&&a?.nodeName==="DIV"&&a?.firstChild?.nodeName==="IMG"&&o?.nodeName==="DIV"&&o?.firstChild?.nodeName==="P"},replacement:function(r,e){const a=e.children[0]?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=e.children[1]?.textContent;return o&&s?`![${c||""}](${o} "${s}")`:e.outerHTML}}),i.addRule("aba-figure-4",{filter:function(r){const e=r.getAttribute("class");return r.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(r,e){const a=e.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=e.textContent;return o&&s?`![${c||""}](${o} "${s}")

`:s&&!o?`![${c||""}](image/missing-image.png "${s}")

`:e.outerHTML}}),i.addRule("aba-pre-code",{filter:function(r){const e=r.getAttribute("class");return r.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1},replacement:function(r){return"    "+r+`
`}}),i.addRule("nobreak spans",{filter:function(r){return r.nodeName==="SPAN"&&r.getAttribute("class")==="NoBreak"},replacement:r=>r.trim()}),i.addRule("cite",{filter:"cite",replacement:function(r){return"*"+r+"*"}}),i.remove(r=>r.nodeName==="SPAN"&&r.textContent===" "),i}u(lt,"toMarkdownParser");async function j(t,n){const i={},r=await B(t,n);if(r){i.markup=r;const e=G.load(r),a=e("title").text();a&&!n.startsWith(a)&&(i.title=a);const o=e("h1").text();o&&(i.title??=o,e("h1").remove());const c=e("div.chapterheading img, div.ch_open_img img");c&&(i.chapterImage=c?.attr("src")||void 0,e(c).remove()),i.links??=[],e('a[href^="http"]').each((s,f)=>{const d=e(f)?.attr("href");d&&i.links?.push(d)}),i.markdown=ct(e.html())}return i}u(j,"getChapter");async function B(t,n){const i=await p(t);if(i.files[`OEBPS/${n}`]!==void 0)return await i.files[`OEBPS/${n}`].async("string")}u(B,"getRawChapter");const ut={output:"./output",preserveDates:!0};async function E(t,n={}){const i={...ut,...n},r=await p(t);let e=Object.keys(r.files);i.matching!==void 0&&(e=e.filter(o=>N.isMatch(o,i.matching)));const a=b.dir(i.output??".");for(const o of e){const c=r.file(o);if(c){const s=i.rewritePaths?i.rewritePaths(o):o,f=await c.async("nodebuffer");a.write(s,f),i.preserveDates&&await H.utimes(a.path(s),{btime:c.date,mtime:c.date})}}}u(E,"copyFiles");async function ft(t,n="rgba"){const i=await p(t);if(i.files["OEBPS/image/cover.jpg"]!==void 0)return await i.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(r=>x.read(r)).then(r=>r.getPixelColor(50,500)).then(r=>n==="hex"?"#"+r.toString(16).slice(0,6):x.intToRGBA(r))}u(ft,"getCoverColor");const dt={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image*/*.*",convertToMarkdown:!0,resolveLinks:!0};async function pt(t,n={}){const i={...dt,...n},r=await p(t),e=b.dir(i.root);if(i.data){const a=await z(r),o=await ft(r,"hex");e.dir(i.data).write("meta.json",{color:o,...a}),e.dir(i.data).write("files.json",await w(r)),e.dir(i.data).write("toc.json",await y(r))}if(i.chapters){const a=await y(r);let o=i.useToc?a.map(s=>s.content):(await w(r)).filter(s=>N.isMatch(s,i.chapterPattern));o=o.map(s=>s.split("#")[0]),o=[...new Set(o).values()];let c=0;for(const s of o){const f=await j(r,s);if(f.markup){const d={};f.title&&(d.title=f.title.replace(/Chapter \d+\.\s*/,"")),f.chapterImage&&(d.headerImage=f.chapterImage,d.chapterNumber=++c);const h=a.find(L=>L.content===s);h&&(h.playOrder&&(d.tocOrder=h.playOrder),h.navLabel&&(d.title??=h.navLabel));const S=f.markdown??"",R=s.replace(/\..?html/,".md");e.dir(i.chapters).write(R,F.stringify(S,d))}}}i.images&&await E(r,{matching:i.assetPattern,preserveDates:!0,rewritePaths:a=>a.replace("OEBPS/image/",""),output:e.dir(i.images).path()})}u(pt,"processBook"),exports.copyFiles=E,exports.getChapter=j,exports.getMeta=z,exports.getRawChapter=B,exports.getRawMeta=P,exports.getRawToc=O,exports.getToc=y,exports.listContents=w,exports.loadBook=p,exports.processBook=pt;
