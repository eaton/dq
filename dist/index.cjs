"use strict";var O=Object.defineProperty;var u=(a,i)=>O(a,"name",{value:i,configurable:!0});var N=require("jszip"),p=require("fs-jetpack"),b=require("xml2js"),s=require("zod"),S=require("turndown"),$=require("cheerio"),w=require("micromatch"),M=require("utimes"),R=require("gray-matter"),y=require("jimp");function B(a){var i=Object.create(null);return a&&Object.keys(a).forEach(function(r){if(r!=="default"){var t=Object.getOwnPropertyDescriptor(a,r);Object.defineProperty(i,r,t.get?t:{enumerable:!0,get:function(){return a[r]}})}}),i.default=a,Object.freeze(i)}u(B,"_interopNamespaceDefault");var E=B($);async function d(a){if(typeof a=="string"){const i=await p.readAsync(a,"buffer").then(r=>{if(r)return N.loadAsync(r)});if(i===void 0)throw new Error("EBook file could not be read");return i}else return a}u(d,"loadBook");async function m(a){return await d(a).then(i=>Object.keys(i.files))}u(m,"listContents");const T=b.Parser;async function v(a){const i=await z(a),t=await new T({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[n=>n.startsWith("dc:")?n.replace("dc:",""):n]}).parseStringPromise(i),e=D.safeParse(t);if(e.success)return e.data.package.metadata;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(v,"getMeta");async function z(a){return await d(a).then(i=>i.files["OEBPS/content.opf"]?.async("string"))}u(z,"getRawMeta");const g=s.z.string().or(s.z.object({text:s.z.string()}).transform(a=>a.text)),I=s.z.object({title:g.optional(),creator:s.z.array(g).or(g).optional(),contributor:s.z.array(g).optional().optional(),publisher:s.z.string().optional(),rights:s.z.string().optional(),subject:s.z.string().or(s.z.array(s.z.string())).optional(),language:g.or(s.z.array(g)).optional(),identifier:g,source:s.z.string().optional(),date:s.z.string()}),D=s.z.object({package:s.z.object({metadata:I})}),q=b.Parser;async function h(a){const i=await P(a),t=await new q({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(i),e=G.safeParse(t);if(e.success)return e.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(h,"getToc");async function P(a){return await d(a).then(i=>i.files["OEBPS/toc.ncx"]?.async("string"))}u(P,"getRawToc");const L=s.z.string().or(s.z.object({text:s.z.string()}).transform(a=>a.text)),_=s.z.string().or(s.z.object({src:s.z.string()}).transform(a=>a.src)),F=s.z.object({id:s.z.string(),playOrder:s.z.coerce.number(),navLabel:L,content:_}),G=s.z.object({ncx:s.z.object({navMap:s.z.object({navPoint:s.z.array(F)})})}),H={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function J(a,i={}){return V(i).turndown(a).trim()}u(J,"toMarkdown");function V(a={}){const i={...H,blankReplacement:(t,e)=>e.isBlock&&!e.matches("figure")?`

`:!e.isBlock&&!e.children?.length&&e.textContent.trim()===""?"":e.outerHTML,...a},r=new S(i);return r.remove("title"),r.addRule("listItem",{filter:"li",replacement:(t,e,n)=>{t=t.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let o=n.bulletListMarker+" ";const l=e.parentNode;if(l.nodeName==="OL"){const c=l.getAttribute("start"),f=Array.prototype.indexOf.call(l.children,e);o=(c?Number(c)+f:f+1)+". "}return o+t+(e.nextSibling&&!/\n$/.test(t)?`
`:"")}}),r.addRule("aba-figure-1",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,o=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.textContent;return o&&c?`![${l}](${o} "${c}")

`:e.outerHTML}}),r.addRule("aba-figure-2",{filter:function(t){const e=t.firstChild,n=e?.getAttribute&&e?.getAttribute("class");return t.nodeName==="FIGURE"&&e.nodeName==="DIV"&&n&&n.indexOf("figure")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,o=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.firstChild.children[1]?.textContent;return o&&c?`![${l}](${o} "${c}")`:e.outerHTML}}),r.addRule("aba-figure-3",{filter:function(t){const e=t.getAttribute("class"),n=t.children[0],o=t.children[1];return t.nodeName==="DIV"&&e&&e.indexOf("figure")!==-1&&n?.nodeName==="DIV"&&n?.firstChild?.nodeName==="IMG"&&o?.nodeName==="DIV"&&o?.firstChild?.nodeName==="P"},replacement:function(t,e){const n=e.children[0]?.firstChild,o=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.children[1]?.textContent;return o&&c?`![${l}](${o} "${c}")`:e.outerHTML}}),r.addRule("aba-pre-code",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1},replacement:function(t){return"    "+t+`
`}}),r.addRule("nobreak spans",{filter:function(t){return t.nodeName==="SPAN"&&t.getAttribute("class")==="NoBreak"},replacement:t=>t.trim()}),r.addRule("cite",{filter:"cite",replacement:function(t){return"*"+t+"*"}}),r.remove(t=>t.nodeName==="SPAN"&&t.textContent===" "),r}u(V,"toMarkdownParser");async function x(a,i){const r={},t=await A(a,i);if(t){r.markup=t;const e=E.load(t),n=e("title").text();n&&(r.title=n||i);const o=e("div.chapterheading img, div.ch_open_img img");o&&(r.headerImage=o?.attr("src")||void 0,e(o).remove()),r.links??=[],e('a[href^="http"]').each((l,c)=>{const f=e(c)?.attr("href");f&&r.links?.push(f)}),r.markdown=J(e.html())}return r}u(x,"getChapter");async function A(a,i){const r=await d(a);if(r.files[`OEBPS/${i}`]!==void 0)return await r.files[`OEBPS/${i}`].async("string")}u(A,"getRawChapter");const U={output:"./output",preserveDates:!0};async function C(a,i={}){const r={...U,...i},t=await d(a);let e=Object.keys(t.files);r.matching!==void 0&&(e=e.filter(o=>w.isMatch(o,r.matching)));const n=p.dir(r.output??".");for(const o of e){const l=t.file(o);if(l){const c=r.rewritePaths?r.rewritePaths(o):o,f=await l.async("nodebuffer");n.write(c,f),r.preserveDates&&await M.utimes(n.path(c),{btime:l.date,mtime:l.date})}}}u(C,"copyFiles");async function W(a,i="rgba"){const r=await d(a);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(t=>y.read(t)).then(t=>t.getPixelColor(50,500)).then(t=>i==="hex"?"#"+t.toString(16).slice(0,6):y.intToRGBA(t))}u(W,"getCoverColor");const Z={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image/*.*",convertToMarkdown:!0,resolveLinks:!0};async function K(a,i={}){const r={...Z,...i},t=await d(a),e=p.dir(r.root);if(r.data){const n=await v(t),o=await W(t,"hex");e.dir(r.data).write("meta.json",{color:o,...n}),e.dir(r.data).write("files.json",await m(t)),e.dir(r.data).write("toc.json",await h(t))}if(r.chapters){const n=await h(t);let o=r.useToc?n.map(l=>l.content):(await m(t)).filter(l=>w.isMatch(l,r.chapterPattern));o=o.map(l=>l.split("#")[0]),o=[...new Set(o).values()];for(const l of o){const c=await x(t,l);if(c.markup){const f={};c.title&&(f.title=c.title),c.order&&(f.order=c.order),c.headerImage&&(f.headerImage=c.headerImage);const k=c.markdown??"",j=l.replace(/\..?html/,".md");e.dir(r.chapters).write(j,R.stringify(k,f))}}}r.images&&await C(t,{matching:r.assetPattern,preserveDates:!0,rewritePaths:n=>n.replace("OEBPS/image/",""),output:e.dir(r.images).path()})}u(K,"processBook"),exports.copyFiles=C,exports.getChapter=x,exports.getMeta=v,exports.getRawChapter=A,exports.getRawMeta=z,exports.getRawToc=P,exports.getToc=h,exports.listContents=m,exports.loadBook=d,exports.processBook=K;
