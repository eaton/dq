"use strict";var m=Object.defineProperty;var n=(e,t)=>m(e,"name",{value:t,configurable:!0});var l=require("jszip"),u=require("fs-jetpack"),z=require("micromatch"),b=require("path"),v=require("utimes"),y=require("xml2js"),r=require("zod");const A={output:"./output",preserveDates:!0,preservePath:!0};async function k(e,t={}){const a={...A,...t},c=await u.readAsync(e,"buffer").then(s=>{if(s)return l.loadAsync(s)});if(c===void 0)throw new Error("EBook file could not be read");let o=Object.keys(c.files);a.matching!==void 0&&(o=o.filter(s=>z.isMatch(s,a.matching)));const i=u.dir(a.output??".");for(const s of o){const f=c.file(s);if(f){const d=a.preservePath?s:b.parse(s).base,h=await f.async("nodebuffer");i.write(d,h),a.preserveDates&&await v.utimes(i.path(d),{btime:f.date,mtime:f.date})}}}n(k,"copyFiles");async function E(e){return await u.readAsync(e,"buffer").then(t=>{if(t)return l.loadAsync(t);throw new Error("EBook file could not be read")}).then(t=>Object.keys(t.files))}n(E,"listContents");const P=y.Parser,j={};async function x(e,t={}){({...j,...t});const a=await g(e),o=await new P({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[i=>i.startsWith("dc:")?i.replace("dc:",""):i]}).parseStringPromise(a);return q.parse(o).package.metadata}n(x,"parseMeta");async function g(e){return await u.readAsync(e,"buffer").then(t=>{if(t)return l.loadAsync(t);throw new Error("EBook file could not be read")}).then(t=>t.files["OEBPS/content.opf"]?.async("string"))}n(g,"getRawMeta");const p=r.z.object({id:r.z.string(),text:r.z.string()}).transform(e=>e.text),q=r.z.object({package:r.z.object({metadata:r.z.object({title:r.z.string(),creator:p,contributor:r.z.array(p),publisher:r.z.string(),rights:r.z.string(),subject:r.z.array(r.z.string()),language:r.z.string(),identifier:p,source:r.z.string(),date:r.z.string()})})}),B=y.Parser,M={};async function S(e,t={}){({...M,...t});const a=await w(e);return await new B({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0}).parseStringPromise(a)}n(S,"parseToc");async function w(e){return await u.readAsync(e,"buffer").then(t=>{if(t)return l.loadAsync(t);throw new Error("EBook file could not be read")}).then(t=>t.files["OEBPS/toc.ncx"]?.async("string"))}n(w,"getRawToc"),exports.copyFiles=k,exports.getRawMeta=g,exports.getRawToc=w,exports.listContents=E,exports.parseMeta=x,exports.parseToc=S;
