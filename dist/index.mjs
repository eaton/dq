var j=Object.defineProperty;var u=(e,r)=>j(e,"name",{value:r,configurable:!0});import S from"jszip";import d from"fs-jetpack";import g from"xml2js";import{z as a}from"zod";import T from"micromatch";import{utimes as O}from"utimes";import B from"gray-matter";import h from"jimp";import C from"turndown";import $ from"wretch";import A from"p-settle";import*as M from"cheerio";async function f(e){if(typeof e=="string"){const r=await d.readAsync(e,"buffer").then(t=>{if(t)return S.loadAsync(t)});if(r===void 0)throw new Error("EBook file could not be read");return r}else return e}u(f,"loadBook");async function E(e){return await f(e).then(r=>Object.keys(r.files))}u(E,"listContents");const L=g.Parser;async function w(e){const r=await x(e),s=await new L({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[n=>n.startsWith("dc:")?n.replace("dc:",""):n]}).parseStringPromise(r);return R.parse(s).package.metadata}u(w,"getMeta");async function x(e){return await f(e).then(r=>r.files["OEBPS/content.opf"]?.async("string"))}u(x,"getRawMeta");const m=a.string().or(a.object({text:a.string()}).transform(e=>e.text)),z=a.object({title:a.string(),creator:a.array(m).or(m).optional(),contributor:a.array(m).optional().optional(),publisher:a.string().optional(),rights:a.string().optional(),subject:a.array(a.string()).optional(),language:a.string(),identifier:m,source:a.string().optional(),date:a.string()}),R=a.object({package:a.object({metadata:z})}),q=g.Parser;async function y(e){const r=await b(e),s=await new q({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(r);return J.parse(s).ncx.navMap.navPoint}u(y,"getToc");async function b(e){return await f(e).then(r=>r.files["OEBPS/toc.ncx"]?.async("string"))}u(b,"getRawToc");const D=a.string().or(a.object({text:a.string()}).transform(e=>e.text)),F=a.string().or(a.object({src:a.string()}).transform(e=>e.src)),N=a.object({id:a.string(),playOrder:a.coerce.number(),navLabel:D,content:F}),J=a.object({ncx:a.object({navMap:a.object({navPoint:a.array(N)})})});async function k(e,r){const t=await f(e);if(t.files[`OEBPS/${r}`]!==void 0)return await t.files[`OEBPS/${r}`].async("string")}u(k,"getChapter");const G={output:"./output",preserveDates:!0};async function v(e,r={}){const t={...G,...r},s=await f(e);let n=Object.keys(s.files);t.matching!==void 0&&(n=n.filter(i=>T.isMatch(i,t.matching)));const o=d.dir(t.output??".");for(const i of n){const c=s.file(i);if(c){const l=t.rewritePaths?t.rewritePaths(i):i,p=await c.async("nodebuffer");o.write(l,p),t.preserveDates&&await O(o.path(l),{btime:c.date,mtime:c.date})}}}u(v,"copyFiles");async function H(e,r="rgba"){const t=await f(e);if(t.files["OEBPS/image/cover.jpg"]!==void 0)return await t.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(s=>h.read(s)).then(s=>s.getPixelColor(50,500)).then(s=>r==="hex"?"#"+s.toString(16).slice(0,6):h.intToRGBA(s))}u(H,"getCoverColor");const I={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function U(e,r={}){return W(r).turndown(e)}u(U,"toMarkdown");function W(e={}){const r={...I,blankReplacement:(s,n)=>n.isBlock&&!n.matches("figure")?`

`:n.outerHTML,...e},t=new C(r);return t.remove("title"),t.addRule("listItem",{filter:"li",replacement:(s,n,o)=>{s=s.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let i=o.bulletListMarker+" ";const c=n.parentNode;if(c.nodeName==="OL"){const l=c.getAttribute("start"),p=Array.prototype.indexOf.call(c.children,n);i=(l?Number(l)+p:p+1)+". "}return i+s+(n.nextSibling&&!/\n$/.test(s)?`
`:"")}}),t.addRule("aba-figure",{filter:"figure",replacement:function(s,n){const o=n.firstChild.firstChild.firstChild,i=o.getAttribute("src"),c=o.getAttribute("alt"),l=n.firstChild.children[1].textContent;return`![${c}](${i} "${l}")`}}),t}u(W,"toMarkdownParser");async function Z(e){const r=M.load(e),t=new Map;r("a[href]").each((o,i)=>{const c=r(i).attr("href");c&&t.set(c,void 0)});const s=[];for(const o of t.keys())o.includes("bkaprt.com")&&s.push(K(o));const n=[];for(const o of await A(s,{concurrency:1}))o.isFulfilled&&n.push(o.value);return n}u(Z,"expandLinks");async function K(e){const r=new URL(e);return r.protocol="https:",await $(e).get().notFound(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"not found"})).unauthorized(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"unauthorized"})).forbidden(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"forbidden"})).timeout(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.text??"timeout"})).res(t=>({requested:e,redirected:t.url,status:t.status,statusText:t.statusText})).catch(t=>(console.log(t),{requested:e,redirected:t.response?.url?t.response.url:t.url,status:t.response?.status?t.response?.status:t.status,statusText:t.response?.statusText?t.response.statusText:t.text??t.message}))}u(K,"expand");const Q={data:"./output",images:"./output/image",chapters:"./output/src",fonts:!1,expandLinks:!0};async function V(e,r={}){const t={...Q,...r},s=await f(e);if(t.data){const n=await w(s),o=await H(s,"hex");d.dir(t.data).write("meta.json",{color:o,...n})}if(t.chapters){const n=[],o=await y(s);for(const i of o){if(i.content.indexOf("#")>-1)continue;const c=await k(s,i.content);if(c){const l={title:i.navLabel,order:i.playOrder};t.expandLinks&&n.push(...await Z(c));const p=U(c),P=i.content.replace(".xhtml",".md");d.dir(t.chapters).write(P,B.stringify({content:p},l))}t.data&&n.length&&d.dir(t.data).write("links.json",n)}}t.images&&await v(s,{matching:"**/image/*.*",preserveDates:!0,rewritePaths:n=>n.replace("OEBPS/image/",""),output:t.images})}u(V,"processBook");export{v as copyFiles,k as getChapter,w as getMeta,x as getRawMeta,b as getRawToc,y as getToc,E as listContents,f as loadBook,V as processBook};
