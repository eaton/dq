var S=Object.defineProperty;var u=(a,o)=>S(a,"name",{value:o,configurable:!0});import $ from"jszip";import p from"fs-jetpack";import b from"xml2js";import{z as s}from"zod";import O from"turndown";import*as M from"cheerio";import w from"micromatch";import{utimes as B}from"utimes";import R from"gray-matter";import y from"jimp";async function m(a){if(typeof a=="string"){const o=await p.readAsync(a,"buffer").then(r=>{if(r)return $.loadAsync(r)});if(o===void 0)throw new Error("EBook file could not be read");return o}else return a}u(m,"loadBook");async function g(a){return await m(a).then(o=>Object.keys(o.files))}u(g,"listContents");const E=b.Parser;async function x(a){const o=await A(a),t=await new E({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[n=>n.startsWith("dc:")?n.replace("dc:",""):n]}).parseStringPromise(o),e=T.safeParse(t);if(e.success)return e.data.package.metadata;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(x,"getMeta");async function A(a){return await m(a).then(o=>o.files["OEBPS/content.opf"]?.async("string"))}u(A,"getRawMeta");const d=s.string().or(s.object({text:s.string()}).transform(a=>a.text)),I=s.object({title:d.optional(),creator:s.array(d).or(d).optional(),contributor:s.array(d).optional().optional(),publisher:s.string().optional(),rights:s.string().optional(),subject:s.string().or(s.array(s.string())).optional(),language:d.or(s.array(d)).optional(),identifier:d,source:s.string().optional(),date:s.string()}),T=s.object({package:s.object({metadata:I})}),D=b.Parser;async function h(a){const o=await P(a),t=await new D({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(o),e=_.safeParse(t);if(e.success)return e.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(h,"getToc");async function P(a){return await m(a).then(o=>o.files["OEBPS/toc.ncx"]?.async("string"))}u(P,"getRawToc");const L=s.string().or(s.object({text:s.string()}).transform(a=>a.text)),z=s.string().or(s.object({src:s.string()}).transform(a=>a.src)),F=s.object({id:s.string(),playOrder:s.coerce.number(),navLabel:L,content:z}),_=s.object({ncx:s.object({navMap:s.object({navPoint:s.array(F)})})}),G={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function H(a,o={}){return J(o).turndown(a).trim()}u(H,"toMarkdown");function J(a={}){const o={...G,blankReplacement:(t,e)=>e.isBlock&&!e.matches("figure")?`

`:!e.isBlock&&!e.children?.length&&e.textContent.trim()===""?"":e.outerHTML,...a},r=new O(o);return r.remove("title"),r.addRule("listItem",{filter:"li",replacement:(t,e,n)=>{t=t.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let i=n.bulletListMarker+" ";const l=e.parentNode;if(l.nodeName==="OL"){const c=l.getAttribute("start"),f=Array.prototype.indexOf.call(l.children,e);i=(c?Number(c)+f:f+1)+". "}return i+t+(e.nextSibling&&!/\n$/.test(t)?`
`:"")}}),r.addRule("aba-figure-1",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.textContent;return i&&c?`![${l}](${i} "${c}")

`:e.outerHTML}}),r.addRule("aba-figure-2",{filter:function(t){const e=t.firstChild,n=e?.getAttribute&&e?.getAttribute("class");return t.nodeName==="FIGURE"&&e.nodeName==="DIV"&&n&&n.indexOf("figure")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.firstChild.children[1]?.textContent;return i&&c?`![${l}](${i} "${c}")`:e.outerHTML}}),r.addRule("aba-figure-3",{filter:function(t){const e=t.getAttribute("class"),n=t.children[0],i=t.children[1];return t.nodeName==="DIV"&&e&&e.indexOf("figure")!==-1&&n?.nodeName==="DIV"&&n?.firstChild?.nodeName==="IMG"&&i?.nodeName==="DIV"&&i?.firstChild?.nodeName==="P"},replacement:function(t,e){const n=e.children[0]?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.children[1]?.textContent;return i&&c?`![${l}](${i} "${c}")`:e.outerHTML}}),r.addRule("aba-pre-code",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1},replacement:function(t){return"    "+t+`
`}}),r.addRule("nobreak spans",{filter:function(t){return t.nodeName==="SPAN"&&t.getAttribute("class")==="NoBreak"},replacement:t=>t.trim()}),r.addRule("cite",{filter:"cite",replacement:function(t){return"*"+t+"*"}}),r.remove(t=>t.nodeName==="SPAN"&&t.textContent===" "),r}u(J,"toMarkdownParser");async function v(a,o){const r={},t=await k(a,o);if(t){r.markup=t;const e=M.load(t),n=e("title").text();n&&(r.title=n||o);const i=e("div.chapterheading img, div.ch_open_img img");i&&(r.headerImage=i?.attr("src")||void 0,e(i).remove()),r.links??=[],e('a[href^="http"]').each((l,c)=>{const f=e(c)?.attr("href");f&&r.links?.push(f)}),r.markdown=H(e.html())}return r}u(v,"getChapter");async function k(a,o){const r=await m(a);if(r.files[`OEBPS/${o}`]!==void 0)return await r.files[`OEBPS/${o}`].async("string")}u(k,"getRawChapter");const V={output:"./output",preserveDates:!0};async function C(a,o={}){const r={...V,...o},t=await m(a);let e=Object.keys(t.files);r.matching!==void 0&&(e=e.filter(i=>w.isMatch(i,r.matching)));const n=p.dir(r.output??".");for(const i of e){const l=t.file(i);if(l){const c=r.rewritePaths?r.rewritePaths(i):i,f=await l.async("nodebuffer");n.write(c,f),r.preserveDates&&await B(n.path(c),{btime:l.date,mtime:l.date})}}}u(C,"copyFiles");async function U(a,o="rgba"){const r=await m(a);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(t=>y.read(t)).then(t=>t.getPixelColor(50,500)).then(t=>o==="hex"?"#"+t.toString(16).slice(0,6):y.intToRGBA(t))}u(U,"getCoverColor");const W={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image/*.*",convertToMarkdown:!0,resolveLinks:!0};async function Z(a,o={}){const r={...W,...o},t=await m(a),e=p.dir(r.root);if(r.data){const n=await x(t),i=await U(t,"hex");e.dir(r.data).write("meta.json",{color:i,...n}),e.dir(r.data).write("files.json",await g(t)),e.dir(r.data).write("toc.json",await h(t))}if(r.chapters){const n=await h(t);let i=r.useToc?n.map(l=>l.content):(await g(t)).filter(l=>w.isMatch(l,r.chapterPattern));i=i.map(l=>l.split("#")[0]),i=[...new Set(i).values()];for(const l of i){const c=await v(t,l);if(c.markup){const f={};c.title&&(f.title=c.title),c.order&&(f.order=c.order),c.headerImage&&(f.headerImage=c.headerImage);const j=c.markdown??"",N=l.replace(/\..?html/,".md");e.dir(r.chapters).write(N,R.stringify(j,f))}}}r.images&&await C(t,{matching:r.assetPattern,preserveDates:!0,rewritePaths:n=>n.replace("OEBPS/image/",""),output:e.dir(r.images).path()})}u(Z,"processBook");export{C as copyFiles,v as getChapter,x as getMeta,k as getRawChapter,A as getRawMeta,P as getRawToc,h as getToc,g as listContents,m as loadBook,Z as processBook};
