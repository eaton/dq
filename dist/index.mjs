var I=Object.defineProperty;var u=(e,n)=>I(e,"name",{value:n,configurable:!0});import D from"jszip";import b from"fs-jetpack";import N from"xml2js";import{z as l}from"zod";import H from"turndown";import*as F from"cheerio";import x from"micromatch";import{utimes as z}from"utimes";import G from"gray-matter";import v from"jimp";async function d(e){if(typeof e=="string"){const n=await b.readAsync(e,"buffer").then(i=>{if(i)return D.loadAsync(i)});if(n===void 0)throw new Error("EBook file could not be read");return n}else return e}u(d,"loadBook");async function w(e){return await d(e).then(n=>Object.keys(n.files))}u(w,"listContents");const _=N.Parser;async function P(e){const n=await k(e),r=await new _({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[a=>a.startsWith("dc:")?a.replace("dc:",""):a]}).parseStringPromise(n),t=V.safeParse(r);if(t.success)return t.data.package.metadata;throw console.log(JSON.stringify(r,void 0,2)),t.error}u(P,"getMeta");async function k(e){return await d(e).then(n=>n.files["OEBPS/content.opf"]?.async("string"))}u(k,"getRawMeta");const m=l.string().or(l.object({text:l.string()}).transform(e=>e.text)),J=l.object({title:m.optional(),creator:l.array(m).or(m).optional(),contributor:l.array(m).optional().optional(),publisher:l.string().optional(),rights:l.string().optional(),subject:l.string().or(l.array(l.string())).optional(),language:m.or(l.array(m)).optional(),identifier:m,source:l.string().optional(),date:l.string()}),V=l.object({package:l.object({metadata:J})}),U=N.Parser;async function C(e){const n=await T(e),r=await new U({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(n),t=q.safeParse(r);if(t.success)return t.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(r,void 0,2)),t.error}u(C,"getToc");async function T(e){return await d(e).then(n=>n.files["OEBPS/toc.ncx"]?.async("string"))}u(T,"getRawToc");const W=l.string().or(l.object({text:l.string()}).transform(e=>e.text)),Y=l.string().or(l.object({src:l.string()}).transform(e=>e.src)),Z=l.object({id:l.string(),playOrder:l.coerce.number(),navLabel:W,content:Y}),q=l.object({ncx:l.object({navMap:l.object({navPoint:l.array(Z)})})}),K=Array.prototype.indexOf,Q=Array.prototype.every,g={},X={left:":--",right:"--:",center:":-:"};g.tableCell={filter:["th","td"],replacement:function(e,n){return A($(n))?e:y(e,n)}},g.tableRow={filter:"tr",replacement:function(e,n){const i=$(n);if(A(i))return e;let r="";if(tt(n)){const t=S(i);for(let a=0;a<t;a++){const o=t>=n.childNodes.length?null:n.childNodes[a];let c="---";const s=o?(o.getAttribute("align")||"").toLowerCase():"";s&&(c=X[s]||c),o?r+=y(c,n.childNodes[a]):r+=y(c,null,a)}}return`
`+e+(r?`
`+r:"")}},g.table={filter:function(e){return e.nodeName==="TABLE"},replacement:function(e,n){if(A(n))return e;e=e.replace(/\n+/g,`
`);let i;et(n.firstChild)&&(i=n.firstChild.textContent,n.firstChild.remove());let r=e.trim().split(`
`);r.length>=2&&(r=[r[1]]);const t=r.indexOf("| ---")===0,a=S(n);let o="";return a&&!t&&(o="|"+"     |".repeat(a)+`
|`+" --- |".repeat(a)),i?`

`+i+`

`+o+e+`

`:`

`+o+e+`

`}},g.tableSection={filter:["thead","tbody","tfoot"],replacement:function(e){return e}};function tt(e){const n=e.parentNode;return n.nodeName==="THEAD"||n.firstChild===e&&(n.nodeName==="TABLE"||rt(n))&&Q.call(e.childNodes,function(i){return i.nodeName==="TH"})}u(tt,"isHeadingRow");function et(e){return e.parentNode.nodeName==="TABLE"&&e.nodeName==="CAPTION"}u(et,"isTableCaption");function rt(e){const n=e.previousSibling;return e.nodeName==="TBODY"&&(!n||n.nodeName==="THEAD"&&/^\s*$/i.test(n.textContent))}u(rt,"isFirstTbody");function y(e,n,i){i===null&&(i=K.call(n.parentNode.childNodes,n));let r=" ";i===0&&(r="| ");let t=e.trim().replace(/\n\r/g,"<br>").replace(/\n/g,"<br>");for(t=t.replace(/\|+/g,"\\|");t.length<3;)t+=" ";return n&&(t=nt(t,n," ")),r+t+" |"}u(y,"cell");function O(e){if(!e.childNodes)return!1;for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(i.nodeName==="TABLE"||O(i))return!0}return!1}u(O,"nodeContainsTable");function A(e){return!!(!e||!e.rows||e.rows.length===1&&e.rows[0].childNodes.length<=1||O(e))}u(A,"tableShouldBeSkipped");function $(e){let n=e.parentNode;for(;n.nodeName!=="TABLE";)if(n=n.parentNode,!n)return null;return n}u($,"nodeParentTable");function nt(e,n,i){const r=n.getAttribute("colspan")||1;for(let t=1;t<r;t++)e+=" | "+i.repeat(3);return e}u(nt,"handleColSpan");function S(e){let n=0;for(let i=0;i<e.rows.length;i++){const t=e.rows[i].childNodes.length;t>n&&(n=t)}return n}u(S,"tableColCount");function it(e){e.keep(function(n){return n.nodeName==="TABLE"}),e.remove("caption");for(const n in g)e.addRule(n,g[n])}u(it,"tables");const at={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function ot(e,n={}){return st(n).turndown(e).trim()}u(ot,"toMarkdown");function st(e={}){const n={...at,blankReplacement:(r,t)=>t.isBlock&&!t.matches("figure")?`

`:!t.isBlock&&!t.children?.length&&t.textContent?.trim()===""?"":t.outerHTML,...e},i=new H(n).use([it]);return i.remove("title"),i.addRule("listItem",{filter:"li",replacement:(r,t,a)=>{r=r.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let o=a.bulletListMarker+" ";const c=t.parentNode;if(c?.nodeName==="OL"){const s=c.getAttribute("start"),f=Array.prototype.indexOf.call(c.children,t);o=(s?Number(s)+f:f+1)+". "}return o+r+(t.nextSibling&&!/\n$/.test(r)?`
`:"")}}),i.addRule("aba-figure-1",{filter:function(r){const t=r.getAttribute("class");return r.nodeName==="FIGURE"&&t&&t.indexOf("figFrame")!==-1},replacement:function(r,t){const a=t.firstChild?.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=t.textContent;return o&&s?`![${c||""}](${o} "${s}")

`:s&&!o?`![${c||""}](image/missing-image.png "${s}")

`:t.outerHTML}}),i.addRule("aba-figure-2",{filter:function(r){const t=r.firstChild,a=t?.getAttribute&&t?.getAttribute("class");return r.nodeName==="FIGURE"&&t.nodeName==="DIV"&&a&&a.indexOf("figure")!==-1},replacement:function(r,t){const a=t.firstChild?.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=t.firstChild.children[1]?.textContent;return o&&s?`![${c||""}](${o} "${s}")`:t.outerHTML}}),i.addRule("aba-figure-3",{filter:function(r){const t=r.getAttribute("class"),a=r.children[0],o=r.children[1];return r.nodeName==="DIV"&&t&&t.indexOf("figure")!==-1&&a?.nodeName==="DIV"&&a?.firstChild?.nodeName==="IMG"&&o?.nodeName==="DIV"&&o?.firstChild?.nodeName==="P"},replacement:function(r,t){const a=t.children[0]?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=t.children[1]?.textContent;return o&&s?`![${c||""}](${o} "${s}")`:t.outerHTML}}),i.addRule("aba-figure-4",{filter:function(r){const t=r.getAttribute("class");return r.nodeName==="FIGURE"&&t&&t.indexOf("figFrame")!==-1},replacement:function(r,t){const a=t.firstChild?.firstChild,o=a?.getAttribute&&a?.getAttribute("src"),c=a?.getAttribute&&a?.getAttribute("alt"),s=t.textContent;return o&&s?`![${c||""}](${o} "${s}")

`:s&&!o?`![${c||""}](image/missing-image.png "${s}")

`:t.outerHTML}}),i.addRule("aba-pre-code",{filter:function(r){const t=r.getAttribute("class");return r.nodeName==="PRE"&&t&&t.indexOf("Code")!==-1},replacement:function(r){return"    "+r+`
`}}),i.addRule("nobreak spans",{filter:function(r){return r.nodeName==="SPAN"&&r.getAttribute("class")==="NoBreak"},replacement:r=>r.trim()}),i.addRule("cite",{filter:"cite",replacement:function(r){return"*"+r+"*"}}),i.remove(r=>r.nodeName==="SPAN"&&r.textContent===" "),i}u(st,"toMarkdownParser");async function B(e,n){const i={},r=await E(e,n);if(r){i.markup=r;const t=F.load(r),a=t("title").text();a&&!n.startsWith(a)&&(i.title=a);const o=t("h1").text();o&&(i.title??=o,t("h1").remove());const c=t("div.chapterheading img, div.ch_open_img img");c&&(i.chapterImage=c?.attr("src")||void 0,t(c).remove()),i.links??=[],t('a[href^="http"]').each((s,f)=>{const p=t(f)?.attr("href");p&&i.links?.push(p)}),i.markdown=ot(t.html())}return i}u(B,"getChapter");async function E(e,n){const i=await d(e);if(i.files[`OEBPS/${n}`]!==void 0)return await i.files[`OEBPS/${n}`].async("string")}u(E,"getRawChapter");const ct={output:"./output",preserveDates:!0};async function L(e,n={}){const i={...ct,...n},r=await d(e);let t=Object.keys(r.files);i.matching!==void 0&&(t=t.filter(o=>x.isMatch(o,i.matching)));const a=b.dir(i.output??".");for(const o of t){const c=r.file(o);if(c){const s=i.rewritePaths?i.rewritePaths(o):o,f=await c.async("nodebuffer");a.write(s,f),i.preserveDates&&await z(a.path(s),{btime:c.date,mtime:c.date})}}}u(L,"copyFiles");async function lt(e,n="rgba"){const i=await d(e);if(i.files["OEBPS/image/cover.jpg"]!==void 0)return await i.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(r=>v.read(r)).then(r=>r.getPixelColor(50,500)).then(r=>n==="hex"?"#"+r.toString(16).slice(0,6):v.intToRGBA(r))}u(lt,"getCoverColor");const ut={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image*/*.*",convertToMarkdown:!0,resolveLinks:!0};async function ft(e,n={}){const i={...ut,...n},r=await d(e),t=b.dir(i.root);if(i.data){const a=await P(r),o=await lt(r,"hex");t.dir(i.data).write("meta.json",{color:o,...a}),t.dir(i.data).write("files.json",await w(r)),t.dir(i.data).write("toc.json",await C(r))}if(i.chapters){const a=await C(r);let o=i.useToc?a.map(s=>s.content):(await w(r)).filter(s=>x.isMatch(s,i.chapterPattern));o=o.map(s=>s.split("#")[0]),o=[...new Set(o).values()];let c=0;for(const s of o){const f=await B(r,s);if(f.markup){const p={};f.title&&(p.title=f.title.replace(/Chapter \d+\.\s*/,"")),f.chapterImage&&(p.headerImage=f.chapterImage,p.chapterNumber=++c);const h=a.find(M=>M.content===s);h&&(h.playOrder&&(p.tocOrder=h.playOrder),h.navLabel&&(p.title??=h.navLabel));const j=f.markdown??"",R=s.replace(/\..?html/,".md");t.dir(i.chapters).write(R,G.stringify(j,p))}}}i.images&&await L(r,{matching:i.assetPattern,preserveDates:!0,rewritePaths:a=>a.replace("OEBPS/image/",""),output:t.dir(i.images).path()})}u(ft,"processBook");export{L as copyFiles,B as getChapter,P as getMeta,E as getRawChapter,k as getRawMeta,T as getRawToc,C as getToc,w as listContents,d as loadBook,ft as processBook};
