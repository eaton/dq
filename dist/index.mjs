var F=Object.defineProperty;var s=(t,e)=>F(t,"name",{value:e,configurable:!0});import H from"jszip";import w from"fs-jetpack";import x from"xml2js";import{z as c}from"zod";import z from"turndown";import*as G from"cheerio";import v from"micromatch";import{utimes as _}from"utimes";import J from"gray-matter";import k from"jimp";async function d(t){if(typeof t=="string"){const e=await w.readAsync(t,"buffer").then(r=>{if(r)return H.loadAsync(r)});if(e===void 0)throw new Error("EBook file could not be read");return e}else return t}s(d,"loadBook");async function C(t){return await d(t).then(e=>Object.keys(e.files))}s(C,"listContents");const V=x.Parser;async function S(t){const e=await P(t),n=await new V({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[o=>o.startsWith("dc:")?o.replace("dc:",""):o]}).parseStringPromise(e),i=W.safeParse(n);if(i.success)return i.data.package.metadata;throw console.log(JSON.stringify(n,void 0,2)),i.error}s(S,"getMeta");async function P(t){return await d(t).then(e=>e.files["OEBPS/content.opf"]?.async("string"))}s(P,"getRawMeta");const g=c.string().or(c.object({text:c.string()}).transform(t=>t.text)),U=c.object({title:g.optional(),creator:c.array(g).or(g).optional(),contributor:c.array(g).optional().optional(),publisher:c.string().optional(),rights:c.string().optional(),subject:c.string().or(c.array(c.string())).optional(),language:g.or(c.array(g)).optional(),identifier:g,source:c.string().optional(),date:c.string()}),W=c.object({package:c.object({metadata:U})}),Y=x.Parser;async function y(t){const e=await T(t),n=await new Y({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(e),i=Q.safeParse(n);if(i.success)return i.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(n,void 0,2)),i.error}s(y,"getToc");async function T(t){return await d(t).then(e=>e.files["OEBPS/toc.ncx"]?.async("string"))}s(T,"getRawToc");const Z=c.string().or(c.object({text:c.string()}).transform(t=>t.text)),q=c.string().or(c.object({src:c.string()}).transform(t=>t.src)),K=c.object({id:c.string(),playOrder:c.coerce.number(),navLabel:Z,content:q}),Q=c.object({ncx:c.object({navMap:c.object({navPoint:c.array(K)})})}),X=Array.prototype.indexOf,tt=Array.prototype.every,h={},et={left:":--",right:"--:",center:":-:"};h.tableCell={filter:["th","td"],replacement:function(t,e){return N(O(e))?t:A(t,e)}},h.tableRow={filter:"tr",replacement:function(t,e){const r=O(e);if(N(r))return t;let n="";if(rt(e)){const i=$(r);for(let o=0;o<i;o++){const a=i>=e.childNodes.length?null:e.childNodes[o];let l="---";const u=a?(a.getAttribute("align")||"").toLowerCase():"";u&&(l=et[u]||l),a?n+=A(l,e.childNodes[o]):n+=A(l,null,o)}}return`
`+t+(n?`
`+n:"")}},h.table={filter:function(t){return t.nodeName==="TABLE"},replacement:function(t,e){if(N(e))return t;t=t.replace(/\n+/g,`
`);let r;nt(e.firstChild)&&(r=e.firstChild.textContent,e.firstChild.remove());let n=t.trim().split(`
`);n.length>=2&&(n=[n[1]]);const i=n[0].indexOf("| ---")===0,o=$(e);let a="";return o&&!i&&(a="|"+"     |".repeat(o)+`
|`+" --- |".repeat(o)),r?`

`+r+`

`+a+t+`

`:`

`+a+t+`

`}},h.tableSection={filter:["thead","tbody","tfoot"],replacement:function(t){return t}};function rt(t){const e=t.parentNode;return e.nodeName==="THEAD"||e.firstChild===t&&(e.nodeName==="TABLE"||it(e))&&tt.call(t.childNodes,function(r){return r.nodeName==="TH"})}s(rt,"isHeadingRow");function nt(t){return t.parentNode.nodeName==="TABLE"&&t.nodeName==="CAPTION"}s(nt,"isTableCaption");function it(t){const e=t.previousSibling;return t.nodeName==="TBODY"&&(!e||e.nodeName==="THEAD"&&/^\s*$/i.test(e.textContent))}s(it,"isFirstTbody");function A(t,e,r){r===null&&(r=X.call(e.parentNode.childNodes,e));let n=" ";r===0&&(n="| ");let i=t.trim().replace(/\n\r/g,"<br>").replace(/\n/g,"<br>");for(i=i.replace(/\|+/g,"\\|");i.length<3;)i+=" ";return e&&(i=at(i,e," ")),n+i+" |"}s(A,"cell");function B(t){if(!t.childNodes)return!1;for(let e=0;e<t.childNodes.length;e++){const r=t.childNodes[e];if(r.nodeName==="TABLE"||B(r))return!0}return!1}s(B,"nodeContainsTable");function N(t){return!!(!t||!t.rows||t.rows.length===1&&t.rows[0].childNodes.length<=1||B(t))}s(N,"tableShouldBeSkipped");function O(t){let e=t.parentNode;for(;e.nodeName!=="TABLE";)if(e=e.parentNode,!e)return null;return e}s(O,"nodeParentTable");function at(t,e,r){const n=e.getAttribute("colspan")||1;for(let i=1;i<n;i++)t+=" | "+r.repeat(3);return t}s(at,"handleColSpan");function $(t){let e=0;for(let r=0;r<t.rows.length;r++){const i=t.rows[r].childNodes.length;i>e&&(e=i)}return e}s($,"tableColCount");function ot(t){t.keep(function(e){return e.nodeName==="TABLE"}),t.remove("caption");for(const e in h)t.addRule(e,h[e])}s(ot,"tables");function st(t){t.addRule("nobreak spans",{filter:function(e){return e.nodeName==="SPAN"&&e.getAttribute("class")==="NoBreak"},replacement:e=>e.trim()})}s(st,"abaNobrSpans");function ct(t){t.addRule("aba-figure-1",{filter:function(e){const r=e.getAttribute("class");return e.nodeName==="FIGURE"&&r&&r.indexOf("figFrame")!==-1},replacement:function(e,r){const n=r.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.textContent;return i&&a?`![${o||""}](${i} "${a}")

`:a&&!i?`![${o||""}](image/missing-image.png "${a}")

`:r.outerHTML}}),t.addRule("aba-figure-2",{filter:function(e){const r=e.firstChild,n=r?.getAttribute&&r?.getAttribute("class");return e.nodeName==="FIGURE"&&r.nodeName==="DIV"&&n&&n.indexOf("figure")!==-1},replacement:function(e,r){const n=r.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.firstChild.children[1]?.textContent;return i&&a?`![${o||""}](${i} "${a}")`:r.outerHTML}}),t.addRule("aba-figure-3",{filter:function(e){const r=e.getAttribute("class"),n=e.children[0],i=e.children[1];return e.nodeName==="DIV"&&r&&r.indexOf("figure")!==-1&&n?.nodeName==="DIV"&&n?.firstChild?.nodeName==="IMG"&&i?.nodeName==="DIV"&&i?.firstChild?.nodeName==="P"},replacement:function(e,r){const n=r.children[0]?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.children[1]?.textContent;return i&&a?`![${o||""}](${i} "${a}")`:r.outerHTML}}),t.addRule("aba-figure-4",{filter:function(e){const r=e.getAttribute("class");return e.nodeName==="FIGURE"&&r&&r.indexOf("figFrame")!==-1},replacement:function(e,r){const n=r.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),o=n?.getAttribute&&n?.getAttribute("alt"),a=r.textContent;return i&&a?`![${o||""}](${i} "${a}")

`:a&&!i?`![${o||""}](image/missing-image.png "${a}")

`:r.outerHTML}})}s(ct,"abaFigures");const E={};function lt(t){t.addRule("aba-pre-code",E.abaCode)}s(lt,"abaCodeBlocks");function p(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1}s(p,"isAbaCodeBlock");function ut(t){return!(!p(t)||t.previousSibling&&p(t.previousSibling)||!(t.nextSibling&&p(t.nextSibling)))}s(ut,"isOpeningCodeBlock");function ft(t){return!(!p(t)||!(t.previousSibling&&p(t.previousSibling))||t.nextSibling&&p(t.nextSibling))}s(ft,"isFinalCodeBlock");function pt(t){return!(!p(t)||!(t.previousSibling&&p(t.previousSibling))||!(t.nextSibling&&p(t.nextSibling)))}s(pt,"isMidCodeBlock"),E.abaCode={filter:function(t){return p(t)},replacement:function(t,e,r){return e.isCode=!0,t?(t=t.replace(/\r?\n|\r/g," "),ut(e)?`
`+r.fence+`
`+t+`
`:pt(e)?t+`
`:ft(e)?t+`
`+r.fence+`

`:t):""}};function mt(t){t.addRule("listItem",{filter:"li",replacement:(e,r,n)=>{e=e.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let i=n.bulletListMarker+" ";const o=r.parentNode;if(o?.nodeName==="OL"){const a=o.getAttribute("start"),l=Array.prototype.indexOf.call(o.children,r);i=(a?Number(a)+l:l+1)+". "}return i+e+(r.nextSibling&&!/\n$/.test(e)?`
`:"")}})}s(mt,"noIndentListItem");const dt={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function gt(t,e={}){return ht(e).turndown(t).trim()}s(gt,"toMarkdown");function ht(t={}){const e={...dt,blankReplacement:(n,i)=>i.isBlock&&!i.matches("figure")?`

`:!i.isBlock&&!i.children?.length&&i.textContent?.trim()===""?"":i.outerHTML,...t},r=new z(e).use([ot,st,ct,lt,mt]);return r.remove("title"),r.addRule("cite",{filter:"cite",replacement:function(n){return"*"+n+"*"}}),r.remove(n=>n.nodeName==="SPAN"&&n.textContent===" "),r}s(ht,"toMarkdownParser");async function L(t,e){const r={},n=await j(t,e);if(n){r.markup=n;const i=G.load(n),o=i("title").text();o&&!e.startsWith(o)&&(r.title=o);const a=i("h1").text();a&&(r.title??=a,i("h1").remove());const l=i("div.chapterheading img, div.ch_open_img img");l&&(r.chapterImage=l?.attr("src")||void 0,i(l).remove()),r.links??=[],i('a[href^="http"]').each((u,f)=>{const m=i(f)?.attr("href");m&&r.links?.push(m)}),r.markdown=gt(i.html())}return r}s(L,"getChapter");async function j(t,e){const r=await d(t);if(r.files[`OEBPS/${e}`]!==void 0)return await r.files[`OEBPS/${e}`].async("string")}s(j,"getRawChapter");const bt={output:"./output",preserveDates:!0};async function R(t,e={}){const r={...bt,...e},n=await d(t);let i=Object.keys(n.files);r.matching!==void 0&&(i=i.filter(a=>v.isMatch(a,r.matching)));const o=w.dir(r.output??".");for(const a of i){const l=n.file(a);if(l){const u=r.rewritePaths?r.rewritePaths(a):a,f=await l.async("nodebuffer");o.write(u,f),r.preserveDates&&await _(o.path(u),{btime:l.date,mtime:l.date})}}}s(R,"copyFiles");async function wt(t,e="rgba"){const r=await d(t);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(n=>k.read(n)).then(n=>n.getPixelColor(50,500)).then(n=>e==="hex"?"#"+n.toString(16).slice(0,6):k.intToRGBA(n))}s(wt,"getCoverColor");const Ct={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image*/*.*",convertToMarkdown:!0,resolveLinks:!0};async function yt(t,e={}){const r={...Ct,...e},n=await d(t),i=w.dir(r.root);if(r.data){const o=await S(n),a=await wt(n,"hex");i.dir(r.data).write("meta.json",{color:a,...o}),i.dir(r.data).write("files.json",await C(n)),i.dir(r.data).write("toc.json",await y(n))}if(r.chapters){const o=await y(n);let a=r.useToc?o.map(u=>u.content):(await C(n)).filter(u=>v.isMatch(u,r.chapterPattern));a=a.map(u=>u.split("#")[0]),a=[...new Set(a).values()];let l=0;for(const u of a){const f=await L(n,u);if(f.markup){const m={};f.title&&(m.title=f.title.replace(/Chapter \d+\.\s*/,"")),f.chapterImage&&(m.headerImage=f.chapterImage,m.chapterNumber=++l);const b=o.find(D=>D.content===u);b&&(b.playOrder&&(m.tocOrder=b.playOrder),b.navLabel&&(m.title??=b.navLabel));const M=f.markdown??"",I=u.replace(/\..?html/,".md");i.dir(r.chapters).write(I,J.stringify(M,m))}}}r.images&&await R(n,{matching:r.assetPattern,preserveDates:!0,rewritePaths:o=>o.replace("OEBPS/image/",""),output:i.dir(r.images).path()})}s(yt,"processBook");export{R as copyFiles,L as getChapter,S as getMeta,j as getRawChapter,P as getRawMeta,T as getRawToc,y as getToc,C as listContents,d as loadBook,yt as processBook};
