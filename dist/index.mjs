var $=Object.defineProperty;var u=(a,o)=>$(a,"name",{value:o,configurable:!0});import M from"jszip";import g from"fs-jetpack";import w from"xml2js";import{z as s}from"zod";import B from"turndown";import*as R from"cheerio";import y from"micromatch";import{utimes as E}from"utimes";import I from"gray-matter";import x from"jimp";async function p(a){if(typeof a=="string"){const o=await g.readAsync(a,"buffer").then(r=>{if(r)return M.loadAsync(r)});if(o===void 0)throw new Error("EBook file could not be read");return o}else return a}u(p,"loadBook");async function h(a){return await p(a).then(o=>Object.keys(o.files))}u(h,"listContents");const T=w.Parser;async function v(a){const o=await A(a),t=await new T({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[n=>n.startsWith("dc:")?n.replace("dc:",""):n]}).parseStringPromise(o),e=D.safeParse(t);if(e.success)return e.data.package.metadata;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(v,"getMeta");async function A(a){return await p(a).then(o=>o.files["OEBPS/content.opf"]?.async("string"))}u(A,"getRawMeta");const d=s.string().or(s.object({text:s.string()}).transform(a=>a.text)),L=s.object({title:d.optional(),creator:s.array(d).or(d).optional(),contributor:s.array(d).optional().optional(),publisher:s.string().optional(),rights:s.string().optional(),subject:s.string().or(s.array(s.string())).optional(),language:d.or(s.array(d)).optional(),identifier:d,source:s.string().optional(),date:s.string()}),D=s.object({package:s.object({metadata:L})}),z=w.Parser;async function b(a){const o=await P(a),t=await new z({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(o),e=H.safeParse(t);if(e.success)return e.data.ncx.navMap.navPoint;throw console.log(JSON.stringify(t,void 0,2)),e.error}u(b,"getToc");async function P(a){return await p(a).then(o=>o.files["OEBPS/toc.ncx"]?.async("string"))}u(P,"getRawToc");const F=s.string().or(s.object({text:s.string()}).transform(a=>a.text)),_=s.string().or(s.object({src:s.string()}).transform(a=>a.src)),G=s.object({id:s.string(),playOrder:s.coerce.number(),navLabel:F,content:_}),H=s.object({ncx:s.object({navMap:s.object({navPoint:s.array(G)})})}),J={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function V(a,o={}){return U(o).turndown(a).trim()}u(V,"toMarkdown");function U(a={}){const o={...J,blankReplacement:(t,e)=>e.isBlock&&!e.matches("figure")?`

`:!e.isBlock&&!e.children?.length&&e.textContent.trim()===""?"":e.outerHTML,...a},r=new B(o);return r.remove("title"),r.addRule("listItem",{filter:"li",replacement:(t,e,n)=>{t=t.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let i=n.bulletListMarker+" ";const c=e.parentNode;if(c.nodeName==="OL"){const l=c.getAttribute("start"),f=Array.prototype.indexOf.call(c.children,e);i=(l?Number(l)+f:f+1)+". "}return i+t+(e.nextSibling&&!/\n$/.test(t)?`
`:"")}}),r.addRule("aba-figure-1",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),c=n?.getAttribute&&n?.getAttribute("alt"),l=e.textContent;return i&&l?`![${c}](${i} "${l}")

`:e.outerHTML}}),r.addRule("aba-figure-2",{filter:function(t){const e=t.firstChild,n=e?.getAttribute&&e?.getAttribute("class");return t.nodeName==="FIGURE"&&e.nodeName==="DIV"&&n&&n.indexOf("figure")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),c=n?.getAttribute&&n?.getAttribute("alt"),l=e.firstChild.children[1]?.textContent;return i&&l?`![${c}](${i} "${l}")`:e.outerHTML}}),r.addRule("aba-figure-3",{filter:function(t){const e=t.getAttribute("class"),n=t.children[0],i=t.children[1];return t.nodeName==="DIV"&&e&&e.indexOf("figure")!==-1&&n?.nodeName==="DIV"&&n?.firstChild?.nodeName==="IMG"&&i?.nodeName==="DIV"&&i?.firstChild?.nodeName==="P"},replacement:function(t,e){const n=e.children[0]?.firstChild,i=n?.getAttribute&&n?.getAttribute("src"),c=n?.getAttribute&&n?.getAttribute("alt"),l=e.children[1]?.textContent;return i&&l?`![${c}](${i} "${l}")`:e.outerHTML}}),r.addRule("aba-pre-code",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1},replacement:function(t){return"    "+t+`
`}}),r.addRule("nobreak spans",{filter:function(t){return t.nodeName==="SPAN"&&t.getAttribute("class")==="NoBreak"},replacement:t=>t.trim()}),r.addRule("cite",{filter:"cite",replacement:function(t){return"*"+t+"*"}}),r.remove(t=>t.nodeName==="SPAN"&&t.textContent===" "),r}u(U,"toMarkdownParser");async function k(a,o){const r={},t=await C(a,o);if(t){r.markup=t;const e=R.load(t),n=e("title").text();n&&!o.startsWith(n)&&(r.title=n);const i=e("h1").text();i&&(r.heading=i,e("h1").remove());const c=e("div.chapterheading img, div.ch_open_img img");c&&(r.chapterImage=c?.attr("src")||void 0,e(c).remove()),r.links??=[],e('a[href^="http"]').each((l,f)=>{const m=e(f)?.attr("href");m&&r.links?.push(m)}),r.markdown=V(e.html())}return r}u(k,"getChapter");async function C(a,o){const r=await p(a);if(r.files[`OEBPS/${o}`]!==void 0)return await r.files[`OEBPS/${o}`].async("string")}u(C,"getRawChapter");const W={output:"./output",preserveDates:!0};async function j(a,o={}){const r={...W,...o},t=await p(a);let e=Object.keys(t.files);r.matching!==void 0&&(e=e.filter(i=>y.isMatch(i,r.matching)));const n=g.dir(r.output??".");for(const i of e){const c=t.file(i);if(c){const l=r.rewritePaths?r.rewritePaths(i):i,f=await c.async("nodebuffer");n.write(l,f),r.preserveDates&&await E(n.path(l),{btime:c.date,mtime:c.date})}}}u(j,"copyFiles");async function Z(a,o="rgba"){const r=await p(a);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(t=>x.read(t)).then(t=>t.getPixelColor(50,500)).then(t=>o==="hex"?"#"+t.toString(16).slice(0,6):x.intToRGBA(t))}u(Z,"getCoverColor");const q={root:"./output",data:"_data",images:"_static/image",chapters:"_src",useToc:!0,chapterPattern:"**/*.*html",assetPattern:"**/image/*.*",convertToMarkdown:!0,resolveLinks:!0};async function K(a,o={}){const r={...q,...o},t=await p(a),e=g.dir(r.root);if(r.data){const n=await v(t),i=await Z(t,"hex");e.dir(r.data).write("meta.json",{color:i,...n}),e.dir(r.data).write("files.json",await h(t)),e.dir(r.data).write("toc.json",await b(t))}if(r.chapters){const n=await b(t);let i=r.useToc?n.map(c=>c.content):(await h(t)).filter(c=>y.isMatch(c,r.chapterPattern));i=i.map(c=>c.split("#")[0]),i=[...new Set(i).values()];for(const c of i){const l=await k(t,c);if(l.markup){const f={};l.title&&(f.title=l.title),l.heading&&(f.heading=l.heading),l.order&&(f.order=l.order),l.chapterImage&&(f.headerImage=l.chapterImage);const m=n.find(S=>S.content===c);m&&(m.playOrder&&(f.order=m.playOrder),m.navLabel&&(f.title??=m.navLabel));const N=l.markdown??"",O=c.replace(/\..?html/,".md");e.dir(r.chapters).write(O,I.stringify(N,f))}}}r.images&&await j(t,{matching:r.assetPattern,preserveDates:!0,rewritePaths:n=>n.replace("OEBPS/image/",""),output:e.dir(r.images).path()})}u(K,"processBook");export{j as copyFiles,k as getChapter,v as getMeta,C as getRawChapter,A as getRawMeta,P as getRawToc,b as getToc,h as listContents,p as loadBook,K as processBook};
