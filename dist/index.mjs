var O=Object.defineProperty;var f=(e,a)=>O(e,"name",{value:a,configurable:!0});import B from"jszip";import d from"fs-jetpack";import g from"xml2js";import{z as i}from"zod";import $ from"turndown";import*as A from"cheerio";import M from"micromatch";import{utimes as E}from"utimes";import L from"gray-matter";import h from"jimp";async function u(e){if(typeof e=="string"){const a=await d.readAsync(e,"buffer").then(t=>{if(t)return B.loadAsync(t)});if(a===void 0)throw new Error("EBook file could not be read");return a}else return e}f(u,"loadBook");async function z(e){return await u(e).then(a=>Object.keys(a.files))}f(z,"listContents");const H=g.Parser;async function w(e){const a=await y(e),n=await new H({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[r=>r.startsWith("dc:")?r.replace("dc:",""):r]}).parseStringPromise(a);return T.parse(n).package.metadata}f(w,"getMeta");async function y(e){return await u(e).then(a=>a.files["OEBPS/content.opf"]?.async("string"))}f(y,"getRawMeta");const m=i.string().or(i.object({text:i.string()}).transform(e=>e.text)),R=i.object({title:i.string(),creator:i.array(m).or(m).optional(),contributor:i.array(m).optional().optional(),publisher:i.string().optional(),rights:i.string().optional(),subject:i.array(i.string()).optional(),language:i.string(),identifier:m,source:i.string().optional(),date:i.string()}),T=i.object({package:i.object({metadata:R})}),D=g.Parser;async function b(e){const a=await x(e),n=await new D({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(a);return J.parse(n).ncx.navMap.navPoint}f(b,"getToc");async function x(e){return await u(e).then(a=>a.files["OEBPS/toc.ncx"]?.async("string"))}f(x,"getRawToc");const N=i.string().or(i.object({text:i.string()}).transform(e=>e.text)),_=i.string().or(i.object({src:i.string()}).transform(e=>e.src)),F=i.object({id:i.string(),playOrder:i.coerce.number(),navLabel:N,content:_}),J=i.object({ncx:i.object({navMap:i.object({navPoint:i.array(F)})})}),G={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function I(e,a={}){return W(a).turndown(e)}f(I,"toMarkdown");function W(e={}){const a={...G,blankReplacement:(n,r)=>r.isBlock&&!r.matches("figure")?`

`:r.outerHTML,...e},t=new $(a);return t.remove("title"),t.addRule("listItem",{filter:"li",replacement:(n,r,o)=>{n=n.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let s=o.bulletListMarker+" ";const c=r.parentNode;if(c.nodeName==="OL"){const l=c.getAttribute("start"),p=Array.prototype.indexOf.call(c.children,r);s=(l?Number(l)+p:p+1)+". "}return s+n+(r.nextSibling&&!/\n$/.test(n)?`
`:"")}}),t.addRule("aba-figure",{filter:"figure",replacement:function(n,r){const o=r.firstChild?.firstChild?.firstChild,s=o?o.getAttribute("src"):void 0,c=o?o.getAttribute("alt"):void 0,l=r.firstChild?.children[1]?.textContent;return s&&l?`![${c}](${s} "${l}")`:r.outerHTML}}),t}f(W,"toMarkdownParser");async function v(e,a){const t={},n=await k(e,a);if(n){t.xhtml=n;const r=A.load(n),o=r("title");o&&(t.title=o?.text()||void 0,r(o).remove());const s=r("div.chapterheading img");s&&(t.chapterHeading=s?.attr("src")||void 0,r(s).remove()),t.links??=[],r('a[href^="http"]').each((c,l)=>{const p=r(l)?.attr("href");p&&t.links?.push(p)}),t.markdown=I(r.html())}return t}f(v,"getChapter");async function k(e,a){const t=await u(e);if(t.files[`OEBPS/${a}`]!==void 0)return await t.files[`OEBPS/${a}`].async("string")}f(k,"getRawChapter");const Z={output:"./output",preserveDates:!0};async function P(e,a={}){const t={...Z,...a},n=await u(e);let r=Object.keys(n.files);t.matching!==void 0&&(r=r.filter(s=>M.isMatch(s,t.matching)));const o=d.dir(t.output??".");for(const s of r){const c=n.file(s);if(c){const l=t.rewritePaths?t.rewritePaths(s):s,p=await c.async("nodebuffer");o.write(l,p),t.preserveDates&&await E(o.path(l),{btime:c.date,mtime:c.date})}}}f(P,"copyFiles");async function q(e,a="rgba"){const t=await u(e);if(t.files["OEBPS/image/cover.jpg"]!==void 0)return await t.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(n=>h.read(n)).then(n=>n.getPixelColor(50,500)).then(n=>a==="hex"?"#"+n.toString(16).slice(0,6):h.intToRGBA(n))}f(q,"getCoverColor");const K={root:"./output",data:"_data",images:"_static/image",chapters:"_src",fonts:!1,expandLinks:!0};async function Q(e,a={}){const t={...K,...a},n=await u(e),r=d.dir(t.root);if(t.data){const o=await w(n),s=await q(n,"hex");r.dir(t.data).write("meta.json",{color:s,...o})}if(t.chapters){const o=[],s=await b(n);for(const c of s){if(c.content.indexOf("#")>-1)continue;const l=await v(n,c.content);if(l.xhtml){const p={title:l.title??c.navLabel,order:c.playOrder};l.chapterHeading&&(p.chapterHeading=l.chapterHeading),t.expandLinks&&o.push(...l.links?.map(C=>({url:C}))??[]);const j=l.markdown??"",S=c.content.replace(".xhtml",".md");r.dir(t.chapters).write(S,L.stringify({content:j},p))}t.data&&o.length&&r.dir(t.data).write("links.json",o)}}t.images&&await P(n,{matching:"**/image/*.*",preserveDates:!0,rewritePaths:o=>o.replace("OEBPS/image/",""),output:r.dir(t.images).path()})}f(Q,"processBook");export{P as copyFiles,v as getChapter,w as getMeta,k as getRawChapter,y as getRawMeta,x as getRawToc,b as getToc,z as listContents,u as loadBook,Q as processBook};
