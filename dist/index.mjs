var j=Object.defineProperty;var f=(i,a)=>j(i,"name",{value:a,configurable:!0});import $ from"jszip";import d from"fs-jetpack";import g from"xml2js";import{z as o}from"zod";import O from"turndown";import*as S from"cheerio";import B from"micromatch";import{utimes as M}from"utimes";import R from"gray-matter";import h from"jimp";async function m(i){if(typeof i=="string"){const a=await d.readAsync(i,"buffer").then(r=>{if(r)return $.loadAsync(r)});if(a===void 0)throw new Error("EBook file could not be read");return a}else return i}f(m,"loadBook");async function E(i){return await m(i).then(a=>Object.keys(a.files))}f(E,"listContents");const L=g.Parser;async function b(i){const a=await w(i),t=await new L({async:!0,explicitArray:!1,charkey:"text",normalize:!0,mergeAttrs:!0,tagNameProcessors:[e=>e.startsWith("dc:")?e.replace("dc:",""):e]}).parseStringPromise(a);return H.parse(t).package.metadata}f(b,"getMeta");async function w(i){return await m(i).then(a=>a.files["OEBPS/content.opf"]?.async("string"))}f(w,"getRawMeta");const p=o.string().or(o.object({text:o.string()}).transform(i=>i.text)),D=o.object({title:o.string(),creator:o.array(p).or(p).optional(),contributor:o.array(p).optional().optional(),publisher:o.string().optional(),rights:o.string().optional(),subject:o.array(o.string()).optional(),language:o.string(),identifier:p,source:o.string().optional(),date:o.string()}),H=o.object({package:o.object({metadata:D})}),T=g.Parser;async function x(i){const a=await y(i),t=await new T({async:!0,explicitArray:!1,normalize:!0,mergeAttrs:!0,trim:!0}).parseStringPromise(a);return G.parse(t).ncx.navMap.navPoint}f(x,"getToc");async function y(i){return await m(i).then(a=>a.files["OEBPS/toc.ncx"]?.async("string"))}f(y,"getRawToc");const I=o.string().or(o.object({text:o.string()}).transform(i=>i.text)),z=o.string().or(o.object({src:o.string()}).transform(i=>i.src)),F=o.object({id:o.string(),playOrder:o.coerce.number(),navLabel:I,content:z}),G=o.object({ncx:o.object({navMap:o.object({navPoint:o.array(F)})})}),V={hr:"---",emDelimiter:"*",headingStyle:"atx",bulletListMarker:"*",codeBlockStyle:"fenced"};function _(i,a={}){return J(a).turndown(i)}f(_,"toMarkdown");function J(i={}){const a={...V,blankReplacement:(t,e)=>e.isBlock&&!e.matches("figure")?`

`:!e.isBlock&&e.matches("span")&&e.textContent.trim()===""?"":e.outerHTML,...i},r=new O(a);return r.remove("title"),r.addRule("listItem",{filter:"li",replacement:(t,e,n)=>{t=t.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
    `);let s=n.bulletListMarker+" ";const l=e.parentNode;if(l.nodeName==="OL"){const c=l.getAttribute("start"),u=Array.prototype.indexOf.call(l.children,e);s=(c?Number(c)+u:u+1)+". "}return s+t+(e.nextSibling&&!/\n$/.test(t)?`
`:"")}}),r.addRule("aba-figure-1",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="FIGURE"&&e&&e.indexOf("figFrame")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,s=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.textContent;return s&&c?`![${l}](${s} "${c}")

`:e.outerHTML}}),r.addRule("aba-figure-2",{filter:function(t){const e=t.firstChild,n=e?.getAttribute&&e?.getAttribute("class");return t.nodeName==="FIGURE"&&e.nodeName==="DIV"&&n&&n.indexOf("figure")!==-1},replacement:function(t,e){const n=e.firstChild?.firstChild?.firstChild,s=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.firstChild.children[1]?.textContent;return s&&c?`![${l}](${s} "${c}")`:e.outerHTML}}),r.addRule("aba-figure-3",{filter:function(t){const e=t.getAttribute("class"),n=t.children[0],s=t.children[1];return t.nodeName==="DIV"&&e&&e.indexOf("figure")!==-1&&n?.nodeName==="DIV"&&n?.firstChild?.nodeName==="IMG"&&s?.nodeName==="DIV"&&s?.firstChild?.nodeName==="P"},replacement:function(t,e){const n=e.children[0]?.firstChild,s=n?.getAttribute&&n?.getAttribute("src"),l=n?.getAttribute&&n?.getAttribute("alt"),c=e.children[1]?.textContent;return s&&c?`![${l}](${s} "${c}")`:e.outerHTML}}),r.addRule("aba-pre-code",{filter:function(t){const e=t.getAttribute("class");return t.nodeName==="PRE"&&e&&e.indexOf("Code")!==-1},replacement:function(t){return"    "+t+`
`}}),r.addRule("nobreak spans",{filter:function(t){return t.nodeName==="SPAN"&&console.log(t.textContent),t.nodeName==="SPAN"&&t.getAttribute("class")==="NoBreak"},replacement:t=>t.trim()}),r.remove(t=>t.nodeName==="SPAN"&&t.textContent===" "),r}f(J,"toMarkdownParser");async function A(i,a){const r={},t=await C(i,a);if(t){r.xhtml=t;const e=S.load(t),n=e("title");n&&(r.title=n?.text()||void 0,e(n).remove());const s=e("div.chapterheading img");s&&(r.chapterHeading=s?.attr("src")||void 0,e(s).remove()),r.links??=[],e('a[href^="http"]').each((l,c)=>{const u=e(c)?.attr("href");u&&r.links?.push(u)}),r.markdown=_(e.html())}return r}f(A,"getChapter");async function C(i,a){const r=await m(i);if(r.files[`OEBPS/${a}`]!==void 0)return await r.files[`OEBPS/${a}`].async("string")}f(C,"getRawChapter");const U={output:"./output",preserveDates:!0};async function k(i,a={}){const r={...U,...a},t=await m(i);let e=Object.keys(t.files);r.matching!==void 0&&(e=e.filter(s=>B.isMatch(s,r.matching)));const n=d.dir(r.output??".");for(const s of e){const l=t.file(s);if(l){const c=r.rewritePaths?r.rewritePaths(s):s,u=await l.async("nodebuffer");n.write(c,u),r.preserveDates&&await M(n.path(c),{btime:l.date,mtime:l.date})}}}f(k,"copyFiles");async function W(i,a="rgba"){const r=await m(i);if(r.files["OEBPS/image/cover.jpg"]!==void 0)return await r.files["OEBPS/image/cover.jpg"].async("nodebuffer").then(t=>h.read(t)).then(t=>t.getPixelColor(50,500)).then(t=>a==="hex"?"#"+t.toString(16).slice(0,6):h.intToRGBA(t))}f(W,"getCoverColor");const Z={root:"./output",data:"_data",images:"_static/image",chapters:"_src",fonts:!1,expandLinks:!0};async function q(i,a={}){const r={...Z,...a},t=await m(i),e=d.dir(r.root);if(r.data){const n=await b(t),s=await W(t,"hex");e.dir(r.data).write("meta.json",{color:s,...n})}if(r.chapters){const n=[],s=await x(t);for(const l of s){if(l.content.indexOf("#")>-1)continue;const c=await A(t,l.content);if(c.xhtml){const u={title:l.navLabel,order:l.playOrder};c.chapterHeading&&(u.chapterHeading=c.chapterHeading),r.expandLinks&&n.push(...c.links?.map(N=>({url:N}))??[]);const v=c.markdown??"",P=l.content.replace(".xhtml",".md");e.dir(r.chapters).write(P,R.stringify({content:v},u))}r.data&&n.length&&e.dir(r.data).write("links.json",n)}}r.images&&await k(t,{matching:"**/image/*.*",preserveDates:!0,rewritePaths:n=>n.replace("OEBPS/image/",""),output:e.dir(r.images).path()})}f(q,"processBook");export{k as copyFiles,A as getChapter,b as getMeta,C as getRawChapter,w as getRawMeta,y as getRawToc,x as getToc,E as listContents,m as loadBook,q as processBook};
